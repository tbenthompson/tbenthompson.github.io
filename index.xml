<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>T. Ben Thompson</title><link>http://tbenthompson.com/</link><description>Recent content on T. Ben Thompson</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 14 Jun 2021 00:00:00 +0000</lastBuildDate><atom:link href="http://tbenthompson.com/index.xml" rel="self" type="application/rss+xml"/><item><title>Machine learning engineering at QuantCo.</title><link>http://tbenthompson.com/project/quantco/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/quantco/</guid><description>&lt;p>See &lt;a href="http://tbenthompson.com/resume.pdf">my resume&lt;/a> for some info on what I do at &lt;a href="https://quantco.com/">QuantCo.&lt;/a>&lt;/p></description></item><item><title>cppimport: Import C++ files directly from Python!</title><link>http://tbenthompson.com/project/cppimport/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/cppimport/</guid><description>&lt;p>&lt;a href="https://github.com/tbenthompson/cppimport">See the GitHub repo&lt;/a>&lt;/p></description></item><item><title>GPU-accelerated symmetric Galerkin boundary element software</title><link>http://tbenthompson.com/project/tectosaur/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/tectosaur/</guid><description>&lt;p>&lt;a href="https://eartharxiv.org/xzhuk/">A recent paper outlining our Galerkin BEM approach.&lt;/a>&lt;/p>
&lt;p>My tectonic and earthquake cycle research is supported by development of elastic boundary element software. This has required investigations into the best approaches for a wide range of computational and mathematical tasks: singular integration of Green&amp;rsquo;s functions, approximation of farfield Green&amp;rsquo;s function interactions with the fast multipole method, flexible treatment of equality and inequality constraints, and a big dose of computational geometry. These are a just a few of the components of this effort. This new software will be able to model arbitrary geometries including surface topography, complex data-derived fault geometries, and material boundaries. Models with millions of elements will be possible in two or three dimensions. Exciting!&lt;/p>
&lt;img src="http://tbenthompson.com/images/matrix.png" style="width: 400px;"/>
&lt;p>&lt;em>A visualization of the structure in a boundary element matrix with rotational symmetry.&lt;/em>&lt;/p></description></item><item><title>Earthquake cycle modeling of the Cascadia subduction zone</title><link>http://tbenthompson.com/project/quasidynamic/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/quasidynamic/</guid><description>&lt;p>&lt;a href="https://eartharxiv.org/3vuxw/">Paper&lt;/a>&lt;/p>
&lt;p>The Cascadia subduction zone hosts great $\mathrm{M}_\mathrm{W} &amp;gt; 8.5$ earthquakes, but studying these events is hindered by our short observational record. Earthquake cycle simulation provides an alternative window into the behavior of the subduction zone. Here, we present simulations over 3,800 years, 14 ruptures and hundreds of slow slip events on a high-fidelity geometric representation of the Cascadia subduction zone beneath surface topography. The boundaries of these ruptures are defined by ephemeral stress barriers that last for several cycles but are eliminated by a barrier-crossing rupture. Thus, it is possible that many real world rupture barriers are due to remnant stress shadows from previous slip events and may not persist over several earthquake cycles. In addition, we see &amp;ldquo;fast&amp;rdquo; slow slip events with $\mathrm{M}_\mathrm{W} \approx 8$. These events may occur in nature and reduce the seismically available moment for earthquakes.&lt;/p>
&lt;iframe width="600" height="338" src="https://www.youtube.com/embed/ieN-9MUhND8?start=112" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>&lt;/iframe></description></item><item><title>Topography and the shallow slip deficit inference</title><link>http://tbenthompson.com/project/topography/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/topography/</guid><description>&lt;p>&lt;a href="https://osf.io/sp3bj/">Paper&lt;/a>&lt;/p>
&lt;p>Images of earthquake slip typically rely on flat Earth physical models to link surface observations to fault activity at depth despite the extreme topographic relief (20%) in vicinity of recent great earthquakes (e.g., 2008 $M_w$=7.9 Wenchuan).
Here we use a three-dimensional boundary element approach to characterize the effects of realistic topography on coseismic slip inversions and find that near the steepest topography, the flat Earth assumption may induce errors $&amp;gt;100%$ in imaged coseismic slip.
Additionally, we show that the flat earth assumption even in regions with small topographic gradients (1-5% , 1992 $M_w$=7.3 Landers) can lead to the inaccurate inference of a shallow slip deficit.
This illustrates how physical model errors can be amplified by an order of magnitude in estimating images of coseismic fault slip and that more physically realistic models may be required for accurate inference in an era of rapidly growing geodetic databases.&lt;/p>
&lt;img src="http://tbenthompson.com/images/wenchuan_model_3d.png" style="width: 600px;"/>
&lt;p>&lt;em>A view of the Wenchuan model looking south from high above the Earth&amp;rsquo;s surface at the fault model through transparent mountainous topography.&lt;/em>&lt;/p>
&lt;img src="http://tbenthompson.com/images/landers_panels.png" style="width: 600px;"/>
&lt;p>&lt;em>The distribution of slip on the primary segments of the Landers rupture surface as inferred by our model including topographic effects.&lt;/em>&lt;/p></description></item><item><title>Simplified distributed task parallelism</title><link>http://tbenthompson.com/project/taskloaf/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/taskloaf/</guid><description>&lt;p>Task-based parallelism enables running complex parallel computations by describing them as a graph of tasks. Shared memory task-based parallelism has become an important tool as demonstrated by tools like Intel TBB, Cilk, and OpenMP v3. But, distributed memory task-based parallelism systems is still heavily researched to determine the most usable, efficient and scalable approach. Instead of waiting for the future holy grail of distributed task parallelism, I designed Taskloaf while visiting Oak Ridge National Lab in Fall 2015. Taskloaf is a minimal but reasonably efficient and scalable task parallelism library. A primary goal with the library was to keep it small and easy to maintain. The codebase has less than 2k lines of code so that a skilled C++ programmer can learn the inner workings of the entire library in a day. The interface is based around &lt;a href="https://en.wikipedia.org/wiki/Futures_and_promises">futures&lt;/a>, a time-tested parallelism primitive. I use Taskloaf to parallelize my boundary element software.&lt;/p></description></item><item><title>Neural-net-accelerated viscoelastic calculations.</title><link>http://tbenthompson.com/project/visconn/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/visconn/</guid><description>&lt;img src="http://tbenthompson.com/images/nn_grl.jpeg"/>
&lt;p>The viscous behavior of the deep Earth results in slow surface motion continuing for many years after an earthquake. However, computing the physics of this behavior can be extremely expensive involving multi-dimensional inverse Laplace transforms and slowly-convergent series. We developed a basic feedforward neural network that is able to replicate the results of the analytic computation while running ~500x faster. Since the analytic function being approximated is already known, this is a sort of strange application of neural networks in that they are very explicitly being used in their role as universal function approximators for a high-dimensional function. It works really well!&lt;/p></description></item><item><title>Crustal stress estimation in the Himalayan wedge</title><link>http://tbenthompson.com/project/himalaya_stress/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/himalaya_stress/</guid><description>&lt;p>Quantitative estimates of crustal stress magnitude and orientation are hard to come by. On the other hand, geodesy is providing an increasingly accurate picture of global tectonic motions. Field and laboratory analyses contribute fault slip rates and exhumation rates. Seismology yields estimates of stress from moment tensor analyses. I am working to combine these data sources with geometrically accurate elastic boundary element models to estimate the crustal stress field and the driving forces behind those stresses &amp;ndash; for example, mantle tractions on the base of the crust.&lt;/p>
&lt;p>Currently, I am applying these methods to the Himalayan wedge in the vicinity of the 2015 Nepal earthquake. In the past, Coulomb wedge and elastic wedge models provided a qualitative picture of these stresses and the growth of mountain belts over long time scales. My work will make these models quantitative by constraining geometrically realistic wedge models with geodetic and geologic observations. An improved image of the stress in the crust will help answer several questions about active tectonics in the Himalayas. Are stress drops low or high compared to total stress? Is it reasonable that some stress in the Himalayas might be released as plastic strain rather than fault slip? What fault slip rates and directions are consistent with different hypotheses concerning the tectonic driving forces?&lt;/p>
&lt;p>&lt;img src="http://tbenthompson.com/images/hrf_principal_stresses.png" alt="HRF principal stresses">
&lt;em>Principal stress orientations in a cross section of the Himalayan wedge including a frictional detachment and one internal MCT-like fault.&lt;/em>&lt;/p></description></item><item><title>Longmen Shan fault geometry and slip rates</title><link>http://tbenthompson.com/project/longmenshan/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/longmenshan/</guid><description>&lt;p>&lt;em>&lt;a href="http://onlinelibrary.wiley.com/doi/10.1002/2014GL062833/abstract">GRL article&lt;/a>.&lt;/em>&lt;/p>
&lt;p>The Longmen Shan is the steepest topographic front at the India‐Asia collision zone and the site of the Mw 7.9 Wenchuan earthquake. To explain the interseismic GPS velocities across the greater Longmen Shan region, we developed a boundary element model including earthquake cycle effects, topography, the westward dipping Beichuan Fault and a ∼20 km deep, shallowly dipping, detachment, inferred from observed afterslip and from structural considerations. Prior analyses which had neglected the detachment and earthquake cycle effects found shortening rates near zero. In contrast, we found that interseismic GPS data are consistent with a shortening rate of 5.7±1.5mm/yr and maximum surface slip‐deficit rate of 9.5±2.5mm/yr. This model unifies the interpretation of geodetic deformation throughout the earthquake cycle and suggests that the Longmen Shan is an active fold‐and‐thrust belt with Wenchuan‐like recurrence intervals as short as 600 years.&lt;/p>
&lt;p>&lt;img src="http://tbenthompson.com/images/longmenshan.png" />
&lt;em>A cross section of the Longmen Shan showing model-predicted velocities. Positive velocity is to the right/southwest.&lt;/em>&lt;/p></description></item><item><title>Neotectonics of the Shargyn Basin, western Mongolia</title><link>http://tbenthompson.com/project/shargyn/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/shargyn/</guid><description>&lt;p>My undergraduate thesis. Western Mongolia has experienced four of the largest strike-slip earthquakes in recorded history. The Gobi-Altai fault system is a 500km long left-lateral slip zone. The Altai fault system is a 1000km long right-lateral slip zone. Combined these fault systems accomodate 10-15% of the shortening in the Indo-Eurasian collision. At the intersection, complex kinematics have created a 150 x 100km basin, called the Shargyn Basin. I propose an explanation for the kinematics of the ongoing formation of the basin. The main source of data is a 3 month field season in Mongolia.&lt;/p></description></item><item><title>Machine vision for microscale rock deformation</title><link>http://tbenthompson.com/project/microscale/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/microscale/</guid><description>&lt;p>&lt;a href="https://github.com/tbenthompson/microdeform">github&lt;/a>&lt;/p>
&lt;p>For an undergraduate research project, I worked with &lt;a href="https://scholar.google.com/citations?user=4uDVRD0AAAAJ&amp;amp;hl=en">Alejandra&lt;/a> to automate a procedure to quantify finite strain on a microscale. On a certain surface, a sample is etched (like a microprocessor) with spaced dots. Then, on a microscope photograph, the dot positions are recorded before and after deformation. However, tracking hundreds of thousands of these dots by hand is impossible. So, I worked on an algorithm to determine the deformation function between the initial and final images by tracking the dot positions.&lt;/p>
&lt;img src="http://tbenthompson.com/images/sample_centers.png"/>
&lt;p>&lt;em>Identifying the centers (red) of the etched dots.&lt;/em>&lt;/p></description></item><item><title>TherapyCharts</title><link>http://tbenthompson.com/project/therapycharts/</link><pubDate>Fri, 01 Jan 2010</pubDate><guid>http://tbenthompson.com/project/therapycharts/</guid><description>&lt;p>&lt;a href="http://www.therapycharts.com/">homepage&lt;/a>&lt;/p>
&lt;p>I worked for a while as the primary software developer for TherapyCharts, a web-based therapist records system. I developed a Python and PostgreSQL based backend and a ExtJS interface. I participated in two American Psychological Association conferences performing support and sales for TherapyCharts. TherapyCharts has now partnered with Wiley Publishing and is known as “Therascribe powered by TherapyCharts”.&lt;/p></description></item><item><title>Machine learning, neural networks, and melanoma</title><link>http://tbenthompson.com/project/neuralnets/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/project/neuralnets/</guid><description>&lt;p>In high school, I was very interested in machine learning algorithms and investigated neural networks, support vector machines and unsupervised learning. I replicated various algorithms and tested their properties at different points in parameter space on the MNIST dataset which contains 60,000 handwritten numbers. Later, I used an unsupervised learning technique (Autoencoders, Hinton et. al 2006) to improve the performance of a support vector machine model in detecting Melanoma (skin cancer). My technique had a false negative and positive rate similar to experienced doctors. I presented some of these results at ISEF 2007, 2008 and 2009.&lt;/p></description></item><item><title>Gaussian quadrature is not optimal</title><link>http://tbenthompson.com/post/better_than_gauss/</link><pubDate>Mon, 14 Jun 2021</pubDate><guid>http://tbenthompson.com/post/better_than_gauss/</guid><description>&lt;p>It&amp;rsquo;s conventional wisdom that Gauss quadrature is the most point-efficient quadrature formula for analytic functions. But, it&amp;rsquo;s not true! &lt;a href="http://www.cs.ox.ac.uk/files/731/NA-07-15.pdf">&amp;ldquo;New quadrature formulas from conformal maps&amp;rdquo; by Hale and Trefethen (2008)&lt;/a> demonstrate that it&amp;rsquo;s possible to have quadrature formulas that converge about 50% faster for analytic functions. The paper is quite accessible and I encourage you to read it, but I also wanted to help bring attention to it since it seems like it should be more well-known.&lt;/p>
&lt;h3 id="polynomials-vs-analytic-functions">Polynomials vs analytic functions&lt;/h3>
&lt;p>So, where did the misconception that Gauss quadrature is the best possible quadrature rule for smooth functions? I think it comes from framing the problem in terms of the maximum order of polynomial that can be integrated exactly. By that metric, Gauss quadrature &lt;strong>is&lt;/strong> the best that can be done. If we write down a quadrature rule like:&lt;/p>
&lt;p>\begin{equation}
\int_{-1}^{1} f(x) dx \approx \sum_{k}^n w_k f(x_k)
\end{equation}&lt;/p>
&lt;p>then there are $n$ points, $x_k$, and $n$ weights $w_k$. Solving a linear system for the points and weights that exactly integrate a polynomial results in a solvable linear system with $2n$ rows and columns. And a polynomial with order $2n-1$ has $2n$ coefficients, so Gauss quadrature is clearly optimal in the order of polynomial integrable with $N$ points and weights (this isn&amp;rsquo;t a rigorous proof).&lt;/p>
&lt;p>But, it &lt;em>does not follow&lt;/em> that the best quadrature rule for small polynomials is also the best possible quadrature rule for general analytic functions. As the Hale and Trefethen paper demonstrates, Gauss quadrature is suboptimal by approximately a factor of $\pi/2$ in terms of the number of quadrature points required for a given level of error.&lt;/p>
&lt;h3 id="just-give-me-a-quadrature-rule">Just give me a quadrature rule&lt;/h3>
&lt;p>There are several formulas in the paper, but this one is particularly
\begin{align}
\tilde{I}_n(f) &amp;amp;= \sum_k^n \tilde{w}_k f(\tilde{x}_k) , ~~~ \tilde{x}_k = w_kg'(x_k), ~~~ \tilde{x}_k=g(x_k) \\&lt;br>
g(s) &amp;amp;= \frac{1}{53089}(40320s + 6720s^3 + 3024s^5 + 1800s^7 + 1225s^9)
\end{align}&lt;/p>
&lt;h3 id="why-does-this-work">Why does this work?&lt;/h3>
&lt;p>In traditional convergence proofs for Gaussian quadrature, we must assume a little bit more than just having an analytic integrand. The standard approach is to assume that $f(x)$ is analytic in an elliptical domain in the complex plane surrounding the real line segment $[-1, 1]$. The left side of the figure below is showing the right-hand half of such an ellipse. The thing to note is that this is an unbalanced regularity requirement:&lt;/p>
&lt;ul>
&lt;li>near $x=\pm 1$, $f(x)$ is allowed to have singularities or other non-analytic behavior very nearby.&lt;/li>
&lt;li>on the other hand, near $x=0$, $f(x)$ has a very wide domain in which it is analytic.&lt;/li>
&lt;/ul>
&lt;p>Basically, we&amp;rsquo;re putting much more stringent requirements on the center of the domain than on the end points of the domain. The idea in the Hale and Trefethen is to perform a conformal mapping of this ellipse into a domain that is more balanced. This is demonstrated graphically in the figure below.&lt;/p>
&lt;p>&lt;img src="http://tbenthompson.com/images/elliptic_gauss.png" alt="ellipse">&lt;/p>
&lt;h3 id="does-this-actually-work">Does this actually work?&lt;/h3>
&lt;p>For this, I&amp;rsquo;ll just copy the figure from the paper. It depends on the integrand, but for many analytic functions, yes, the new quadrature rule is more point efficient! For further explanation of the successes and failures here, go take a look at the paper!&lt;/p>
&lt;p>&lt;img src="http://tbenthompson.com/images/better_gauss.png" alt="ellipse">&lt;/p>
&lt;h3 id="more-myths">More myths!&lt;/h3>
&lt;p>Check out this &lt;a href="https://people.maths.ox.ac.uk/trefethen/mythspaper.pdf">Lloyd Trefethen essay&lt;/a> for several other myths about polynomials and numerical methods.&lt;/p></description></item><item><title>Reflective deep work</title><link>http://tbenthompson.com/post/reflective_deep_work/</link><pubDate>Fri, 11 Jun 2021</pubDate><guid>http://tbenthompson.com/post/reflective_deep_work/</guid><description>&lt;p>&lt;sub>You might also call this introspective deep work, or self-reflective deep work.&lt;/sub>&lt;/p>
&lt;p>I just finished reading &lt;a href="https://www.goodreads.com/book/show/25744928-deep-work">Deep Work&lt;/a> and it has me thinking about applying a few of the concepts well beyond my career. &amp;ldquo;Deep work&amp;rdquo; is all about making space for the hard intellectual work at the core of most knowledge workers' jobs. But, the concept of making space in your day or week or month for deep thought seems like it should apply well beyond my career. Reflective deep work could even be a unifying theme for a lot of self-help or productivity advice. In some parts of life, I operate on auto-pilot almost all the time. If I&amp;rsquo;m brushing my teeth, that&amp;rsquo;s perfect. But, in other situations, it would be better to occasionally stop and think.&lt;/p>
&lt;p>Examples:&lt;/p>
&lt;ul>
&lt;li>Sitting down with a blank sheet of paper and thinking for an hour about how to improve your relationship with your significant other. Even if the relationship is already great!&lt;/li>
&lt;li>Intentional thought and planning about how to enhance my running training and how to solve my running injuries.&lt;/li>
&lt;li>Puzzling out better dog training techniques when the current approach isn&amp;rsquo;t working. Or even, the mere realization that the current training approach isn&amp;rsquo;t working.&lt;/li>
&lt;/ul>
&lt;p>You might be thinking this all sounds too much like a weekly review. I don&amp;rsquo;t disagree! A &lt;a href="https://www.benkuhn.net/weekly/">weekly review&lt;/a> is a form of reflective deep work normally focused on &lt;a href="https://nesslabs.com/weekly-review">meta-level career topics&lt;/a> or &lt;a href="https://gettingthingsdone.com/wp-content/uploads/2014/10/Weekly_Review_Checklist.pdf">organization&lt;/a>. But, I think it&amp;rsquo;s useful to occasionally go beyond the core goals and topics you might consider in a weekly review. I&amp;rsquo;m going to reserve an hour every couple weeks to think hard about something that I wouldn&amp;rsquo;t normally think about. To avoid missing important subjects, I&amp;rsquo;ll spend the first few minutes listing some options for what to think about that session: random thoughts, activities, people, but probably not work.&lt;/p></description></item><item><title>Why it's okay to share your code</title><link>http://tbenthompson.com/post/share_your_code/</link><pubDate>Mon, 17 May 2021</pubDate><guid>http://tbenthompson.com/post/share_your_code/</guid><description>&lt;p>TL;DR: If you write a paper that involves complex code, share your code freely online. Don&amp;rsquo;t make it pretty. Don&amp;rsquo;t make it easy to use. Refuse to support the code. Just share it!&lt;/p>
&lt;p>People have talked a lot already about why it&amp;rsquo;s a good idea to share code with your research. I want to address a specific component of this. The desire to share good, well-maintained code often becomes a barrier to sharing any code at all. So, here, I&amp;rsquo;d just like to say that we love you, and we love your code too. No matter what it looks like.&lt;/p>
&lt;p>Disclaimer: This mostly comes from my experience in the computational methods and Earth science communities.&lt;/p>
&lt;h2 id="no-you-cant-see-my-work">No, you can’t see my work.&lt;/h2>
&lt;p>I frequently ask people for the code they used to write a paper. The answer is often a deflection or just &amp;ldquo;No.&amp;rdquo; It&amp;rsquo;s depressing because seeing code is so incredibly useful. With a complex algorithm, I&amp;rsquo;m more likely to jump straight to the code if I can rather than trying to read the paper description carefully. The code is the truth. The writing is just the broad strokes. For technical work, there&amp;rsquo;s often dozens of tiny technical decisions that are never important enough to make it into the final published paper. But, at the same time, those little choices are what make or break an implementation. If I&amp;rsquo;m debugging why my implementation doesn&amp;rsquo;t work, I&amp;rsquo;m going to go read your code. I don&amp;rsquo;t need to be able to run it for this to be valuable. It doesn&amp;rsquo;t even need to be clean or easy to understand. If I care enough, I&amp;rsquo;ll spend hours just sifting through line by line.&lt;/p>
&lt;p>Published papers are just a filter on the truth behind your research. In very literal fields like mathematics, the filter is very thin. The proofs and theorems are the truth and can be written literally in paper form. On the far other end, in some fields, the filter is thick. There&amp;rsquo;s no way to share the truth, the lab experiment. The experiment is over. But we can and should share the raw-est results possible and a precise procedure for repeating the experiment. Computational methods and modeling papers are much more on the math side of the spectrum. The truth is straightforwardly sharable in the form of code. But, we don&amp;rsquo;t do it!&lt;/p>
&lt;p>So, let’s discuss a couple of the common reasons I&amp;rsquo;ve heard from people that don&amp;rsquo;t share their code!&lt;/p>
&lt;h2 id="embarrassed-about-the-quality-and-usability">Embarrassed about the quality and usability.&lt;/h2>
&lt;p>These folks aren&amp;rsquo;t even sure the code they share will run at all or produce the results they presented in their paper. They had a good idea and slammed together something that demonstrated that their idea works well enough to publish a paper.&lt;/p>
&lt;p>For these people, I think we need to encourage a culture of acceptance. It’s okay to produce ugly and unusable code. I’ve done it. You’ve done it. We don’t all have the skills to make nice software. It’s even rarer to find those skills in someone who has spent years practicing some other skillset like doing good research! We don’t always have the time to write something reusable and we shouldn’t be expected to. When the bar for publishable work is too high, the result is fewer publications and a longer publication cycle and that’s bad for everyone involved! Apparently the bar for publishing code is so high that we often don’t even do it at all. So I’d like to try going to the opposite extreme and explicitly setting the bar so low that we publish all the code all the time.&lt;/p>
&lt;h2 id="worried-about-the-maintenance-burden">Worried about the maintenance burden.&lt;/h2>
&lt;p>These folks think they will have to maintain the code or support users. For these people, I have a simple message. There is no maintenance burden! You can and should say no. In fact, you’re already quite good at saying no when I email you asking for your code. So, just do it the other way around. Share your code freely and then say no when people ask for help. Unless you want to help. That’s always an option. But don’t feel obligated. The code is the truth and if someone care enough, they can dig through and figure out what they need to on their own.&lt;/p>
&lt;h2 id="all-the-other-reasons-that-i-wont-address-here">All the other reasons that I won&amp;rsquo;t address here&lt;/h2>
&lt;p>There are a lot of other reasons someone would decline to share their code:&lt;/p>
&lt;ul>
&lt;li>Career incentives. They think their secret sauce code is their ticket to a job/tenure/grants/etc. Bummer!&lt;/li>
&lt;li>The code doesn&amp;rsquo;t exist. Data analysis was done using an interactive system and the original source is gone. Scary!&lt;/li>
&lt;li>Proprietary code. But then why is the paper not proprietary? Dang!&lt;/li>
&lt;li>The code only runs on (insert supercomputer here). See above. Being able to just read the code is very valuable.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;m not going to dive into these here, but it&amp;rsquo;s worth thinking about how to train people and redesign incentive systems so that these are no longer barriers.&lt;/p>
&lt;h2 id="some-useful-links">Some useful links:&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://faculty.washington.edu/rjl/pubs/topten/topten.pdf">Randall LeVeque made a more extensive and better argument than me!&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.paperswithcode.com/">Papers with Code&lt;/a> is a great project linking papers and their code repositories. It&amp;rsquo;s focused on the machine learning world. It would be great to have something similar in other areas.&lt;/li>
&lt;li>&lt;a href="https://github.com/paperswithcode/releasing-research-code">This set of guidelines&lt;/a> for releasing machine learning research code.&lt;/li>
&lt;li>&lt;a href="http://rescience.github.io/">ReScience C&lt;/a> is an open-access journal dedicated to reproduction of computational papers.&lt;/li>
&lt;/ul>
&lt;p>&lt;em>Thanks to Greg Wagner, Liz Santorella for helping out. If you want to chat please &lt;a href="mailto:t.ben.thompson@gmail.com">get in touch&lt;/a>!&lt;/em>&lt;/p></description></item><item><title>Maintaining momentum</title><link>http://tbenthompson.com/post/maintaining_momentum/</link><pubDate>Sat, 03 Apr 2021</pubDate><guid>http://tbenthompson.com/post/maintaining_momentum/</guid><description>&lt;h3 id="collaboration-in-an-unstructured-world">Collaboration in an unstructured world&lt;/h3>
&lt;p>While I haven&amp;rsquo;t made any decisions yet, I&amp;rsquo;m currently considering heading off into a much less structured career path which could be variously described as &amp;ldquo;independent scientist&amp;rdquo;, &amp;ldquo;entrepreneuer&amp;rdquo;, &amp;ldquo;contractor&amp;rdquo; or &amp;ldquo;self-employed open-source developer&amp;rdquo;. Along those lines, I&amp;rsquo;ve been wondering what makes work good for me and how I can put the pieces together reliably. I think the critical piece will be to proactively communicate with lots of people.&lt;/p>
&lt;p>At the moment, I work as a machine learning engineer for QuantCo, working together with business people, economists, statisticians and other software engineers to build useful software systems for things like ecommerce pricing or insurance fraud detection. Jobs like this are inherently collaborative. Half the job is to work together with other people to figure out what exactly you should be doing and how to do it. There are strategy discussions, design discussions, pair programming sessions, stand ups and just plan old hang-out-and-chats.&lt;/p>
&lt;p>By comparison, as an independent scientist, there&amp;rsquo;s not necessarily anyone there that is depending on me, helping me or working together with me. Even as a faculty member within the structure of academia, there&amp;rsquo;s a lot of individualism to science. A single research group is often quite disconnected from the rest of the community. Papers aren&amp;rsquo;t normally communicated until they&amp;rsquo;re done. A lot of people simply don&amp;rsquo;t care about the work you&amp;rsquo;re doing. Seminars or conferences can be confrontational. People don&amp;rsquo;t often say what they really think about some research outside of their small social network.&lt;/p>
&lt;p>So, as I&amp;rsquo;ve been considering this potential path, I&amp;rsquo;ve been thinking a lot about how to establish the kind of collaboration I want. And I think part of the solution is to really focus on the people. While the true goal of my work is scientific progress combined with personal fulfullment, a reasonable proxy goal might be to make it all about people and engagement: people that value/use my work, people that talk to me, people that work with me. I doubt the end result will be very different between these objective functions and the people-focused version is going to do a better job of maintaining my momentum.&lt;/p>
&lt;p>Along those lines, these are some rough ideas I&amp;rsquo;ve had:&lt;/p>
&lt;ul>
&lt;li>Find one or more close collaborators. This is my number one collaborative goal &amp;ndash; to find someone who is interested in working together on a daily basis. Not your typical weekly arms-length collaboration. I don&amp;rsquo;t know if this goal is achievable.&lt;/li>
&lt;li>Do projects &lt;strong>for&lt;/strong> people. Facilitate other people&amp;rsquo;s work as much as I can. Make it undeniably valuable for other people to seek me out and work with me.&lt;/li>
&lt;li>Write a lot. I probably won&amp;rsquo;t be publishing articles in journals, but even if I were, the 6-12 month publishing cadence is far too slow to rely completely on publications for communicating with other scientists. I&amp;rsquo;d prefer a feedback loop on the order of a week or two. I plan to use my website for my technical writing.&lt;/li>
&lt;li>Email people on a regular basis. Cold emailing people. Build an email list that I use any time I write a new website post. Recruit hard for my email list. Should I become the guy-who-spams-his-website-posts-to-everyone? Is this a case of no publicity is bad publicity? I&amp;rsquo;m not sure.&lt;/li>
&lt;li>Lots of video calls! Visit in person once the pandemic is over if people are in the northeast.&lt;/li>
&lt;/ul>
&lt;h3 id="three-pillars-of-good-work">Three pillars of good work&lt;/h3>
&lt;p>While discussing some career ideas with a friend recently, she asked me to back up and think about what basic components make work good and productive for me. Below was my attempt at a response:&lt;/p>
&lt;ol>
&lt;li>A medium collaboration level. Maybe ~10-40% of time is spent communicating and working together with good people who are invested in the work I&amp;rsquo;m doing and I&amp;rsquo;m invested in their work.&lt;/li>
&lt;li>Work that is intrinsically motivating. This is a fairly broad category. That could be building something that I think people want, could be fixing something that is broken, could be learning something new.&lt;/li>
&lt;li>Enough control. I don&amp;rsquo;t need to be master of the universe, but without some control, people will treat you poorly, projects will get cancelled and any number of other bad things will happen.&lt;/li>
&lt;/ol>
&lt;p>I think I&amp;rsquo;ve had two of these things at many points and that was super motivating and resulted in high happiness and high productivity:&lt;/p>
&lt;ul>
&lt;li>During grad school, early on, I had instrinsically motivating work (#2) and plenty of control (#3). That was really awesome. I lost some of both due to some of the mistakes I made early on and getting stuck by the need to finish my dissertation when I also knew I was sort of working on a dead-end research-wise that very few people would be interested in. In the absence of organizational requirements like submitting a dissertation, I would&amp;rsquo;ve made a huge pivot in direction around year 4 or so. Maybe I should have made that pivot anyway, but I&amp;rsquo;m not sure. More collaboration (#1) would&amp;rsquo;ve have helped a lot in a couple critical points to help me avoid the mistakes I made.&lt;/li>
&lt;li>I also had #2 and #3 when I was in high school playing with deep learning. Yeah, deep learning! Way back in 2007! I was super motivated and implemented some cool autoencoder stuff. I just wasn&amp;rsquo;t enough of an adult to continue down that path. I needed to have a lot of collaboration with people with more experience and I had none. I needed several years more math skills. I needed to go get in touch with some faculty or grad students working on this stuff. So, this project fell short of its potential due to a lack of collaboration (#1).&lt;/li>
&lt;li>While working at QuantCo, at various points, I&amp;rsquo;ve had #1 and #2. Last year, I was working on improving a forecasting machine learning system at client-name-removed and that definitely qualified as #2 and I had enough interaction with other team members and client stakeholders that I definitely had #1. It was pretty great and I was super motivated. The project was shut down so this ended because I didn&amp;rsquo;t have control (#3).&lt;/li>
&lt;li>I had #1 and #2 when I worked as a software engineer for a web-based therapy records system called TherapyCharts the summer after high school. Fast, dynamic work in an office with the founders. I continued to work on TherapyCharts during college on and off for a couple years as a part-time contractor. But, I had much less motivation. It had become clear to me that the company was not going to be successful and I felt like I needed to jump ship. But, maybe more important was that it had become much less collaborative because I was several hundred miles away and I was only communicating with the founders every few days or once a week.&lt;/li>
&lt;/ul>
&lt;p>I took away two lessons from this list. First, when I&amp;rsquo;ve felt unfocused or unable to get good work done, it was because something was fundamentally &lt;em>wrong&lt;/em> and not because I needed to push harder. You can&amp;rsquo;t push through a fundamentally flawed mathematical method or a flawed business plan. When things went from going great to going badly in the situations above, I probably should&amp;rsquo;ve made changes instead of just languishing or pushing against a brick wall. Second, any time I can think of where I had two of these things was a really good time for my motivation and happiness. I don&amp;rsquo;t know what would happen if I had all three of these things and maintained that situation for a few years. Probably something really good. I should probably try to find that!&lt;/p>
&lt;p>&lt;em>Thanks to Liz Santorella, Ruth Byers, Brendan Meade, Reena Joubert, and Phoebe DeVries for helping me crystallize some of the ideas in this post and for providing some edits. The ideas still are pretty rough and hypothetical, so if you want to chat please &lt;a href="mailto:t.ben.thompson@gmail.com">get in touch&lt;/a>!&lt;/em>&lt;/p></description></item><item><title>Maybe we should stop using planar triangles for fault modeling</title><link>http://tbenthompson.com/post/surface_representation/</link><pubDate>Wed, 31 Mar 2021</pubDate><guid>http://tbenthompson.com/post/surface_representation/</guid><description>&lt;p>Let&amp;rsquo;s consider a model problem where the goal is to calculate the stress on a fault due to some slip on that fault. We also include a topographic free surface. How should we model this surface?&lt;/p>
&lt;p>Should we use planar triangles to model a curved fault? What happens at the junction between two triangles? If we do the natural fault thing and require the slip to be tangential to the suface, the slip vector has a step function at the junction between the two triangles. This must be true because the two triangles have different normal vectors and tangent vectors. On the other hand, if we force slip to be continuous across triangles, we have to allow non-tangential slip because at an edge where two triangles meet the slip vector has to be identical but the tangent vectors are different.&lt;/p>
&lt;p>That means that we&amp;rsquo;re stuck between a rock and a hard place and have to choose:&lt;/p>
&lt;ul>
&lt;li>non-tangential, but continuous slip&lt;/li>
&lt;li>tangential, but discontinuous slip.&lt;/li>
&lt;/ul>
&lt;p>So, planar triangles probably aren&amp;rsquo;t a sustainable or &amp;ldquo;correct&amp;rdquo; way to represent a fault surface unless that surface is perfectly planar or we&amp;rsquo;re zoomed in far enough that the underlying microscale behavior is relevant. Fundamentally the problem is that our fault surface representation is $C^0$, meaning that the function itself is continuous but the derivatives are not. This problem propagates through the whole model up in other ways too. Suppose you choose to have discontinuous, but tangential, slip. Then, there will be stress singularities at every element junction!&lt;/p>
&lt;p>Should we use a smoother fault surface representation? Probably. A $C^1$ fault representation where the normal vector is continuous between adjacent elements solves the problem described in the previous paragraph.&lt;/p>
&lt;p>Let&amp;rsquo;s back up and consider how to mesh our model earthquake problem from the perspective of &lt;em>truth&lt;/em>, &lt;em>accuracy&lt;/em> and &lt;em>robustness&lt;/em>:&lt;/p>
&lt;p>&lt;strong>Truth&lt;/strong>: The underlying true surface of the Earth is fractal and has sharp corners at basically any zoom level. The fault surfaces are probably similarly fractal and non-smooth.&lt;/p>
&lt;p>&lt;strong>Accuracy&lt;/strong>: There is accurate satellite data on the location of the Earth&amp;rsquo;s surface down to about a a few meters resolution. And for faults, depending on where in the world, the uncertainty in fault location is on the order of 10-10000m. So, only a few digits of accuracy could possibly be relevant in these models since there&amp;rsquo;s already a high level of error introduced by the mere location uncertainty in the faults, much less all the other uncertainties that I haven&amp;rsquo;t discussed here. The main goal, at least at this point in the evolution of the earthquake science field, is in terms of qualitative behavior and questions on the scale of 1-50% or even about the sign of an effect (positive or negative).&lt;/p>
&lt;p>&lt;strong>Robustness&lt;/strong>: This is where smoothness gets really important. From my experience, having smooth boundaries makes so much about integral equation methods simpler. Especially for these faulting/crack problems where hypersingular terms are common.&lt;/p>
&lt;h2 id="a-different-approach">A different approach&lt;/h2>
&lt;p>My tentative approach that I&amp;rsquo;ve been exploring is:&lt;/p>
&lt;ul>
&lt;li>Use at least a $C^1$ mesh. Even smoother surfaces should work fine too. An easy way to get a $C^1$ surface is to use cubic splines. Smooth surfaces make the numerics and code much easier because they remove several types of singularities. This is especially relevant because of the hypersingular integrals from faults that result in stress singularities I described above.&lt;/li>
&lt;li>Methods for smooth surfaces tend to be developed by people looking for high-order accuracy. To reduce all forms of error, it makes sense to have accurate representations of both the surfaces involved and the functions defined on that surface. In addition, low order surface discretizations introduce singularities. For example, a boundary element method which is based on $C^0$ elements will have singularities in stress at each element intersection because there&amp;rsquo;s an artificially introduced corner. I don&amp;rsquo;t think the high-order accuracy is particularly important for quasi-static earthquake problems, but in my experience so far these high-order methods tend to work quite well even when the order $p$ is fairly small.&lt;/li>
&lt;li>Modifying non-smooth surfaces to be smooth makes a negligible difference in the model results, especially compared to the other uncertainties. And on the scale of a few meters left or right, there is no real reason to think that input geometries are perfectly correct. I think there&amp;rsquo;s some potential for this point to be wrong in some circumstances. For example, if the small scale roughness is extremely important to the problem, or the purpose of the model is to study a sharp corner in a fault. But, in most situations, using smooth surfaces will be both acceptable and easier. If a corner truly is important, I can do some refinement so that the resulting singularity is sufficiently well resolved.&lt;/li>
&lt;/ul>
&lt;p>&lt;em>Thanks to Andreas Klöckner, Brendan Meade and Andrew Bradley for discussions that led to this post. If you want to chat about these kind of topics, please &lt;a href="mailto:t.ben.thompson@gmail.com">get in touch&lt;/a>!&lt;/em>&lt;/p></description></item><item><title>Cool video of Cascadia earthquake cycle simulations</title><link>http://tbenthompson.com/post/cascadia/</link><pubDate>Tue, 02 Apr 2019</pubDate><guid>http://tbenthompson.com/post/cascadia/</guid><description>&lt;iframe width="600" height="338" src="https://www.youtube.com/embed/ieN-9MUhND8?start=112" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>&lt;/iframe></description></item><item><title>130 million triangular dislocations per second with Python/CUDA</title><link>http://tbenthompson.com/post/cutde/</link><pubDate>Thu, 26 Jul 2018</pubDate><guid>http://tbenthompson.com/post/cutde/</guid><description>&lt;p>&lt;a href="https://github.com/tbenthompson/cutde">See the GitHub repo&lt;/a>&lt;/p></description></item><item><title>CLUDA - Write once, run anywhere with both CUDA and OpenCL.</title><link>http://tbenthompson.com/post/cluda/</link><pubDate>Mon, 02 Apr 2018</pubDate><guid>http://tbenthompson.com/post/cluda/</guid><description>&lt;p>&lt;a href="https://github.com/tbenthompson/cluda">See the GitHub repo&lt;/a>&lt;/p></description></item><item><title>Regularizing rate and state friction for numerical simulation</title><link>http://tbenthompson.com/post/regularized_rate_state/</link><pubDate>Mon, 19 Mar 2018</pubDate><guid>http://tbenthompson.com/post/regularized_rate_state/</guid><description>&lt;p>The standard form for rate and state friction produces undefined results for $V = 0$. Some algebra and calculus and microphysics lead to the commonly used regularized form that is still valid at $V=0$. This is based on the presentation in Rice and Ben-Zion 1996 and Lapusta et. al 2000. There&amp;rsquo;s nothing novel here, but the details of this sort of thing are often glossed over in the literature. So, while working it out for myself, I figured I&amp;rsquo;d write it up!&lt;/p>
&lt;p>Let&amp;rsquo;s start with the common, empirically-derived rate and state friction with the aging law for state evolution.&lt;/p>
&lt;p>\begin{equation}
\tau = \sigma_n (f_0 + a \log(V/V_0) + b \log(V_0\theta/D_c))
\label{rsorig}
\end{equation}&lt;/p>
&lt;p>\begin{equation}
\dot{\theta} = 1 - V\theta / D_c
\label{agingorig}
\end{equation}&lt;/p>
&lt;p>First, I&amp;rsquo;ll transform to use a somewhat different state variable. $\theta$ is hard to intuitively understand, while $\Psi$ is much more intuitive &amp;ndash; it&amp;rsquo;s just the current absolute offset of the friction coefficient.&lt;/p>
&lt;p>\begin{equation}
\Psi = f_0 + b \log(V_0\theta/D_c)
\label{transform}
\end{equation}&lt;/p>
&lt;p>or, for the inverse transformation:&lt;/p>
&lt;p>\begin{equation}
\theta = \frac{D_c}{V_0}\exp(\frac{\Psi - f_0}{b})
\label{invtransform}
\end{equation}&lt;/p>
&lt;p>With this transformation, $\ref{rsorig}$ becomes:&lt;/p>
&lt;p>\begin{equation}
\tau = \sigma_n (\Psi + a \log(V/V_0))
\label{rstransform}
\end{equation}&lt;/p>
&lt;p>For me, this is nicer in that I can understand the new &amp;ldquo;state&amp;rdquo; parameter, $\Psi$, as the current strength of friction when $V = V_0$.&lt;/p>
&lt;p>Now, I&amp;rsquo;ll get the aging law in terms of $\Psi$. Differentiating \ref{transform}:&lt;/p>
&lt;p>\begin{equation}
\dot{\Psi} = b \dot{\theta}/\theta
\end{equation}&lt;/p>
&lt;p>and plugging in for $\dot{\theta}$ from \ref{agingorig}:&lt;/p>
&lt;p>\begin{equation}
\dot{\Psi} = b/\theta - bV / D_c
\end{equation}&lt;/p>
&lt;p>Finally, plug in for $\theta$ from \ref{invtransform}, I get the aging law in terms of $\Psi$.&lt;/p>
&lt;p>\begin{equation}
\dot{\Psi} = \frac{bV_0}{D_c}(\exp(\frac{f_0 - \Psi}{b}) - \frac{V}{V_0})
\label{aging01}
\end{equation}&lt;/p>
&lt;p>With that done, the second step is to actually do the regularization at $V=0$. Solving $\ref{rstransform}$ for $V$:&lt;/p>
&lt;p>\begin{equation}
V = V_0 \exp(\frac{\tau}{a\sigma_n})\exp(-\frac{\Psi}{a})
\end{equation}&lt;/p>
&lt;p>The trouble here is that the $\exp(\frac{\tau}{a\sigma_n})$ term can never be 0 and as a result $V=0$ is impossible. Quoting Lapusta et. al 2000:&lt;/p>
&lt;blockquote>
&lt;p>A drawback of the logarithmic form (28a) is that the stress is not defined for V = 0. The logarithmic form was derived from purely empirical considerations to match experimental observations (Dieterich, 1979, 1981; Ruina, 1983). However, it has a theoretical basis, in that such a form would result if the direct velocity effect is due to stress biasing of the activation energy in an Arrhenius rate process at contact junctions, at least in the range for which forward microscopic jumps, in the direction of shear stress, are overwhelmingly more frequent than backward jumps.&lt;/p>
&lt;/blockquote>
&lt;p>So, the $\exp(\frac{\tau}{a\sigma_n})$ term represents the frequency of forward microscopic jumps. What about backward microscopic jumps? They happen too, especially near $V=0$. That suggests adding another term like $-\exp(\frac{-\tau}{a\sigma_n})$ to represent backward microscopic jumps:&lt;/p>
&lt;p>\begin{equation}
V = V_0 (\exp(\frac{\tau}{a\sigma_n}) - \exp(\frac{-\tau}{a\sigma_n}))\exp(-\frac{\Psi}{a}) = 2 V_0 \sinh(\frac{\tau}{a\sigma_n})\exp(-\frac{\Psi}{a})
\end{equation}&lt;/p>
&lt;p>Solving for $\tau$ and I get the regularized rate-state friction system:&lt;/p>
&lt;p>\begin{equation}
\tau = \sigma_n a \sinh^{-1}(\frac{V}{2V_0}\exp(\Psi/a))
\label{rsreg}
\end{equation}&lt;/p>
&lt;p>\begin{equation}
\dot{\Psi} = \frac{bV_0}{D_c}(\exp(\frac{f_0 - \Psi}{b}) - \frac{V}{V_0})
\label{aging01-2}
\end{equation}&lt;/p>
&lt;p>In my numerical quasidynamic models, I am using equations \ref{rsreg} and \ref{aging01-2}, rather than the more traditional \ref{rsorig} and \ref{agingorig}. Most other rate and state friction implementations (both fully dynamic and quasidynamic) that I have read about also use the regularized forms.&lt;/p></description></item><item><title>A quasidynamic spring block slider</title><link>http://tbenthompson.com/post/block_slider/</link><pubDate>Sat, 10 Mar 2018</pubDate><guid>http://tbenthompson.com/post/block_slider/</guid><description>&lt;p>&lt;em>source available &lt;a href="block_slider.ipynb">here&lt;/a>&lt;/em>&lt;/p>
&lt;p>Figures first, explanations later!&lt;/p>
&lt;img src="qd_1d.png" alt="Evolution of a quasidynamic spring-block-slider system."/>
&lt;p>Recently, I&amp;rsquo;ve been working on some 3D quasidynamic earthquake modeling problems. We&amp;rsquo;re planning to add in some realistic geometries using tectosaur to see what influence that has on the earthquake cycle. While putting together that 3D model, I realized that it consists of two main pieces:&lt;/p>
&lt;ul>
&lt;li>The numerical methods for determining traction on the fault surface given the current values of slip everywhere on the fault (elasticity!)&lt;/li>
&lt;li>The frictional evolution for determining the current velocity on the fault surface from the traction.&lt;/li>
&lt;/ul>
&lt;p>Or, in pseudocode, it&amp;rsquo;s a simple feedback where I loop:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">while not done:
slip += velocity * dt
traction = elastic_solver(slip)
velocity = rate_state_solver(traction)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I&amp;rsquo;ve been working on the &lt;code>elastic_solver&lt;/code> part for several years (and applying it to a bunch of cool quasistatic problems!) and am quite confident that it&amp;rsquo;s producing the right results. So, when I was running into strange behavior and crazy results, I figured the problems must be in the &lt;code>rate_state_solver&lt;/code>.&lt;/p>
&lt;p>And the &lt;code>rate_state_solver&lt;/code> is actually almost identical in both the 3D problem and a 1D spring block slider problem. So, I set out to repeat the same little exercise that has probably been done a thousand times before.&lt;/p>
&lt;p>If you want a much better designed rate-state friction solver, check out &lt;a href="https://github.com/jrleeman/rsfmodel">John Leeman&amp;rsquo;s rsfmodel package&lt;/a>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">numpy&lt;/span> &lt;span class="kn">as&lt;/span> &lt;span class="nn">np&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">scipy.optimize&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">fsolve&lt;/span>
&lt;span class="kn">from&lt;/span> &lt;span class="nn">scipy.integrate&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">ode&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">odeint&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">matplotlib.pyplot&lt;/span> &lt;span class="kn">as&lt;/span> &lt;span class="nn">plt&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>First, some reasonably typical material property parameters.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">sm&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">3e10&lt;/span> &lt;span class="c1"># Shear modulus (Pa)&lt;/span>
&lt;span class="n">density&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2700&lt;/span> &lt;span class="c1"># rock density (kg/m^3)&lt;/span>
&lt;span class="n">cs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sm&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">density&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># Shear wave speed (m/s)&lt;/span>
&lt;span class="n">eta&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sm&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">cs&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># The radiation damping coefficient (kg / (m^2 * s))&lt;/span>
&lt;span class="n">L&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">60&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">1000&lt;/span> &lt;span class="c1"># Width of our plate boundary (m)&lt;/span>
&lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sm&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">L&lt;/span> &lt;span class="c1"># spring constant (Pa / m)&lt;/span>
&lt;span class="n">Vp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-9&lt;/span> &lt;span class="c1"># Rate of plate motion&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, the regularized rate and state friction law with the aging law, and some simple parameter choices that lead to cyclic earthquake behavior. I&amp;rsquo;m mixing together a few different sources here, but the main ones are:&lt;/p>
&lt;ul>
&lt;li>Erickson and Dunham, &lt;em>An efficient numerical method for earthquake cycles in heterogeneous media: Alternating sub-basin and surface-rupturing events on faults crossing a sedimentary basin, 2014.&lt;/em>&lt;/li>
&lt;li>Segall, &lt;em>Earthquake and Volcano Deformation.&lt;/em>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">sigma_n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">50e6&lt;/span> &lt;span class="c1"># Normal stress (Pa)&lt;/span>
&lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.015&lt;/span> &lt;span class="c1"># direct velocity strengthening effect&lt;/span>
&lt;span class="n">b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.02&lt;/span> &lt;span class="c1"># state-based velocity weakening effect&lt;/span>
&lt;span class="n">Dc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.2&lt;/span> &lt;span class="c1"># state evolution length scale (m)&lt;/span>
&lt;span class="n">f0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.6&lt;/span> &lt;span class="c1"># baseline coefficient of friction&lt;/span>
&lt;span class="n">V0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-6&lt;/span> &lt;span class="c1"># when V = V0, f = f0, V is (m/s)&lt;/span>
&lt;span class="c1"># Rate-state friction law w/ Rice et al 2001 regularization so that &lt;/span>
&lt;span class="c1"># it is nonsingular at V = 0&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">F&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sigma_n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">arcsinh&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">V0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">state&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="c1"># the frictional stress is equal to the friction coefficient * the normal stress.&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">f&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">sigma_n&lt;/span>
&lt;span class="c1"># State evolution law -- aging law.&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">G&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">V0&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">Dc&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">exp&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">f0&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">V0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>I&amp;rsquo;ll check $k_{crit}$.&lt;/p>
&lt;p>If $k &amp;gt; k_{crit}$, the system is unconditionally unstable and $V \to \infty$.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">kcrit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sigma_n&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">Dc&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;k/kcrit =&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">kcrit&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>k/kcrit = 0.1
&lt;/code>&lt;/pre>
&lt;p>Great!&lt;/p>
&lt;p>Next, I&amp;rsquo;ll set up the initial conditions for the model:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">x_0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0&lt;/span> &lt;span class="c1"># slider position&lt;/span>
&lt;span class="n">V_slider_0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Vp&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1000.0&lt;/span> &lt;span class="c1"># Initially, the slider is moving at 1/1000th the plate rate.&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Setting the initial condition for the state variable is non-trivial because I don&amp;rsquo;t want crazy swings at the beginning of the model. So, I solve for the steady-state state variable given the initial velocity. Since $\frac{\partial state}{\partial t}$ &lt;code>= G(V, state)&lt;/code>, that just involves solving for the value of &lt;code>state&lt;/code> at which &lt;code>G(V, state) = 0&lt;/code>. I use the &lt;code>fsolve&lt;/code> scipy function. (Did you notice that equation that was partially Latex and partially code? It felt weird typing that.)&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">steady_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V_slider&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">state&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">G&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V_slider&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">fsolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">state_0&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">steady_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V_slider_0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Okay, so now I&amp;rsquo;m getting to the part where I actually solve the differential equations! But, first, there&amp;rsquo;s an interesting thing about this model. It&amp;rsquo;s actually a differential algebraic equation (DAE) instead of a pure ODE. That&amp;rsquo;s because the current velocity is not defined in differential terms, but instead it is implicity defined as a function of the current shear stress and state parameter. Most of the time, for the 1D spring block slider model that I&amp;rsquo;m looking at here, folks have transformed it into a pure ODE. However, that transformation to an ODE doesn&amp;rsquo;t work very well in the 3D setting. So, for 3D, I&amp;rsquo;m stuck with a DAE. It&amp;rsquo;s not as easy, but it&amp;rsquo;s also not &lt;strong>that&lt;/strong> bad. For the sake of easily translating the 1D model here to use a 3D elastic solver, I&amp;rsquo;m going to actually keep using the DAE formulation.&lt;/p>
&lt;p>So, at each time step, I need to solve an algebraic equation for the current velocity.&lt;/p>
&lt;p>$ \tau_{qs} - F(V, \sigma_n, state) = \eta V$&lt;/p>
&lt;p>Aside: This is actually a transformed version of the typical momentum equation $F = ma$, where $ma$ is replaced by the &amp;ldquo;quasidynamic&amp;rdquo; approximation, $\eta V$ and $F$ is replaced by the driving shear force $\tau_{qs}$ and the resisting friction force $F(V, \sigma_n, state)$&lt;/p>
&lt;p>As an implementation detail, I warm-start the &lt;code>fsolve&lt;/code> call with &lt;code>V_slider_old&lt;/code>, which is the velocity from the previous time step - a decent guess for the new velocity.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">current_vel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tau_qs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">V_slider_old&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">tau_qs&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">eta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">V&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sigma_n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="n">fsolve&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">V_slider_old&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>When using &lt;code>odeint&lt;/code>, I need to define the points in time where I want to observe the state of the system. So, every year, for 15,000 years. (This is not the size of the time step, which is internally decided by &lt;code>odeint&lt;/code>).&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">secs_per_year&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">365&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">24&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">60&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">60&lt;/span>
&lt;span class="n">h_t_yrs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">linspace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">0.0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">15000.0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15001&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">h_t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h_t_yrs&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">secs_per_year&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, I define the derivatives.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x_and_state&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x_and_state&lt;/span>
&lt;span class="c1"># The position of the load point.&lt;/span>
&lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Vp&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">t&lt;/span>
&lt;span class="c1"># The extensional force of our spring &lt;/span>
&lt;span class="n">tau_qs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">y&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># Solve for the current velocity&lt;/span>
&lt;span class="n">V_slider&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">current_vel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tau_qs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">V_slider_old&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># Store the velocity to use it next time for warm-start the velocity solver&lt;/span>
&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">V_slider_old&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">V_slider&lt;/span>
&lt;span class="n">dxdt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">V_slider&lt;/span>
&lt;span class="n">dstatedt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">G&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">V_slider&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">dxdt&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dstatedt&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">V_slider_old&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">V_slider_0&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Define the initial conditions:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">initial_conditions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">array&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="n">x_0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">state_0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And actually solve the equations!&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">history&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">odeint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">initial_conditions&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">rtol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">1e-12&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">atol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mf">1e-12&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mxstep&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">5000&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">h_x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">history&lt;/span>&lt;span class="p">[:,&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">h_state&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">history&lt;/span>&lt;span class="p">[:,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="n">h_V&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h_x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">h_x&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h_t&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">h_t&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;span class="n">h_y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h_t&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">Vp&lt;/span>
&lt;span class="n">h_tau_qs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h_y&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">h_x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">h_tau_qd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h_tau_qs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">eta&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">h_V&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Finally, I&amp;rsquo;ll plot up the results.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1">#plt.style.use(&amp;#39;dark_background&amp;#39;)&lt;/span>
&lt;span class="o">%&lt;/span>&lt;span class="n">matplotlib&lt;/span> &lt;span class="n">inline&lt;/span>
&lt;span class="o">%&lt;/span>&lt;span class="n">config&lt;/span> &lt;span class="n">InlineBackend&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">figure_format&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;retina&amp;#39;&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;text.usetex&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">True&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;font.size&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;axes.labelsize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">18&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;axes.titlesize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;xtick.labelsize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">16&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;ytick.labelsize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">16&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;legend.fontsize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">20&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;figure.titlesize&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">22&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;text.latex.preamble&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">usepackage{amsmath}&amp;#39;&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rcParams&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;savefig.transparent&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">False&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">figure&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">figsize&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">15&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">15&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">ax11&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">subplot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">221&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">label&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;x&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">label&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;y&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">xlabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;t (yrs)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ylabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;position (m)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">legend&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">ax12&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">subplot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">222&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log10&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_V&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">xlabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;t (yrs)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ylabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">log_{10}(V)$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">subplot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">223&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">sharex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ax11&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_tau_qs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">label&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;$&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">tau_{qs}$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:],&lt;/span> &lt;span class="n">h_tau_qd&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">label&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;$&lt;/span>&lt;span class="se">\\&lt;/span>&lt;span class="s1">tau_{qd}$&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">xlabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;t (yrs)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ylabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;shear stress (Pa)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">legend&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">subplot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">224&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">plot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h_t_yrs&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_state&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">xlabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;t (yrs)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ylabel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;state&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">savefig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;qd_1d.pdf&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bbox_inches&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;tight&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">savefig&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;qd_1d.png&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bbox_inches&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;tight&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dpi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">200&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">show&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="block_slider_files/block_slider_26_0.png" alt="png">&lt;/p></description></item><item><title>Cloudpickle, serializing functions and monkey patching</title><link>http://tbenthompson.com/post/cloudpickle_monkey_patching/</link><pubDate>Sat, 24 Feb 2018</pubDate><guid>http://tbenthompson.com/post/cloudpickle_monkey_patching/</guid><description>&lt;p>I&amp;rsquo;ve been using &lt;code>cloudpickle&lt;/code> in the internals of &lt;a href="https://github.com/tbenthompson/taskloaf">taskloaf&lt;/a> for a while since it allows serializing almost all functions and objects. That&amp;rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.&lt;/p>
&lt;p>Yesterday, I was curious about the internals of &lt;code>cloudpickle&lt;/code> and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea.&lt;/p>
&lt;p>I create a silly, meaningless class and then an instance of that class.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="c1"># Create a silly class and an object&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">Turkey&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">hi&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;hello&amp;#34;&lt;/span>
&lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Turkey&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hi&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>hello
&lt;/code>&lt;/pre>
&lt;p>Then, I monkey patch the &lt;code>hi&lt;/code> method to return 1 instead of 2. &lt;code>types.MethodType&lt;/code> turns a free-standing function into a method that automatically receives the &lt;code>self&lt;/code> parameter.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">types&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">hi2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;SQUAWK&amp;#34;&lt;/span>
&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">types&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MethodType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hi2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hi&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>SQUAWK
&lt;/code>&lt;/pre>
&lt;p>First, I&amp;rsquo;ll try &lt;code>pickle&lt;/code>. I dump the turkey to a binary blob and reload it.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">pickle&lt;/span>
&lt;span class="n">blob&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pickle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dumps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">t2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">pickle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">blob&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>---------------------------------------------------------------------------
AttributeError Traceback (most recent call last)
&amp;lt;ipython-input-3-21cb01513bb4&amp;gt; in &amp;lt;module&amp;gt;()
1 import pickle
2 blob = pickle.dumps(t)
----&amp;gt; 3 t2 = pickle.loads(blob)
4 print(t2)
AttributeError: 'Turkey' object has no attribute 'hi2'
&lt;/code>&lt;/pre>
&lt;p>&lt;code>pickle&lt;/code> serialize a reference to the the type of the object and then expects that type to provide all the member functions needed. So, it&amp;rsquo;s not able to handle this monkey patching situation.&lt;/p>
&lt;p>Next, I&amp;rsquo;ll try &lt;code>cloudpickle&lt;/code>!&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">cloudpickle&lt;/span>
&lt;span class="n">t2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">cloudpickle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">loads&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cloudpickle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dumps&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="n">t2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>False
&lt;/code>&lt;/pre>
&lt;p>Does the &lt;code>hi&lt;/code> method remain changed? YES! Thank you, cloudpickle.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hi&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>SQUAWK
&lt;/code>&lt;/pre>
&lt;p>Ultimately, this makes a lot of sense. &lt;code>cloudpickle&lt;/code> just investigates the members of an object (its &lt;code>__dict__&lt;/code>) and serializes those. It doesn&amp;rsquo;t need to serialize anything about the generic &lt;code>Turkey&lt;/code> class. The key difference with &lt;code>pickle&lt;/code> is that &lt;code>cloudpickle&lt;/code> has the capability to serialize functions and so it can directly serialize members of the object without reference to its type.&lt;/p></description></item><item><title>My Python testing set up</title><link>http://tbenthompson.com/post/how_i_test/</link><pubDate>Thu, 22 Feb 2018</pubDate><guid>http://tbenthompson.com/post/how_i_test/</guid><description>&lt;p>To follow up on the last post about testing for science and data analytics, I thought it&amp;rsquo;d be nice to talk about the specific tools I use for testing. I don&amp;rsquo;t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.&lt;/p>
&lt;h2 id="pytest">py.test&lt;/h2>
&lt;p>The py.test tool is handy for running a suite of tests in python. It&amp;rsquo;s a very general tool for running all the tests in a project. It can do a lot of powerful things, but requires almost no boilerplate to get started with. The pattern I&amp;rsquo;ve always followed is: Add a &lt;code>tests&lt;/code> directory the root of the project. Name any test files in that directory &lt;code>test_xyz.py&lt;/code> and then any tests within that file &lt;code>def test_abc():&lt;/code>. py.test will find all of these automatically and run them. On several projects that I work on, I have tens or hundreds of tests that, in total, take less than a second to run. As a result, I simply run &lt;code>py.test&lt;/code> every time I make a change.&lt;/p>
&lt;p>For more happiness, I add a &lt;code>pytest.ini&lt;/code> file to the root of my project:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">[pytest]
addopts = -s --tb=short
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>-s&lt;/code> causes any text printed by my tests or code to appear on the screen. By default, py.test suppresses printing/logging to standard out. Personally, I don&amp;rsquo;t like that while debugging.
The &lt;code>--tb=short&lt;/code> leads to shorter, more concise tracebacks in the case of test failures.&lt;/p>
&lt;p>There are a ton of other features available with py.test, like fixtures, fancy assertions and lots of plugins. Here&amp;rsquo;s &lt;a href="http://pythontesting.net/framework/pytest/pytest-introduction/">a more comprehensive intro to py.test&lt;/a>&lt;/p>
&lt;h2 id="golden-master-tests">Golden master tests&lt;/h2>
&lt;p>Golden master testing doesn&amp;rsquo;t really &lt;strong>require&lt;/strong> any special infrastructure, but it can be nice to have a coordinated way to generate the keys and specify golden master tests. First, I set up a configuration option in &lt;code>tests/conftest.py&lt;/code>. This is a special file that &lt;code>py.test&lt;/code> uses to load plugins and configuration.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">def pytest_addoption(parser):
parser.addoption(
&amp;#34;--save-golden-masters&amp;#34;, action=&amp;#34;store_true&amp;#34;,
help=&amp;#34;reset golden master benchmarks&amp;#34;
)
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then, what you do with this depends on the project. In one project, where I&amp;rsquo;m normally compare numpy arrays, I have a decorator that makes setting up a golden master test really simple.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">def golden_master(digits = 6):
def decorator(test_fnc):
try:
save = pytest.config.getoption(&amp;#34;--save-golden-masters&amp;#34;)
except AttributeError as e:
save = False
@wraps(test_fnc)
def wrapper(request, *args, **kwargs):
result = test_fnc(request, *args, **kwargs)
test_name = request.node.name
filename = os.path.join(&amp;#39;tests&amp;#39;, &amp;#39;golden_masters&amp;#39;, test_name + &amp;#39;.npy&amp;#39;)
if save:
np.save(filename, result)
correct = np.load(filename)
np.testing.assert_almost_equal(result, correct, digits)
return wrapper
return decorator
&lt;/code>&lt;/pre>&lt;/div>&lt;p>To use this:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">@golden_master(4)
def test_mycomplexfnc(request):
return mycomplexfnc()
&lt;/code>&lt;/pre>&lt;/div>&lt;p>When I run &lt;code>py.test --save-golden-masters&lt;/code>, this will automatically save the result of the function to &lt;code>tests/golden_masters/test_mycomplexfnc.npy&lt;/code>. Then, the next time I run &lt;code>py.test&lt;/code>, the output of the &lt;code>mycomplexfnc()&lt;/code> will be compared to 4 digits against the old saved version.&lt;/p>
&lt;p>Modifying this to work with pandas dataframes or other objects would be relatively simple. It could also be refactored to work with general objects without much effort, but, in my case, all the functions where I don&amp;rsquo;t have anything better than a golden master test are functions that return arrays.&lt;/p>
&lt;p>Should you put the saved golden master test results in version control? I would say yes, since they are necessary for properly testing the code base.&lt;/p>
&lt;h2 id="slow-tests">Slow tests&lt;/h2>
&lt;p>Sometimes I have tests that take a little while to run and I don&amp;rsquo;t want them to run every single time I run &lt;code>py.test&lt;/code>. So, I add an opt-in option for running slow tests, following the directions &lt;a href="https://docs.pytest.org/en/latest/example/simple.html#control-skipping-of-tests-according-to-command-line-option">on the py.test docs&lt;/a>.&lt;/p>
&lt;h2 id="pdb--ipdb">pdb + ipdb&lt;/h2>
&lt;p>I thought I&amp;rsquo;d just add a note about debuggers, since I&amp;rsquo;m way more productive with a debugger at hand. When my tests fail and I can&amp;rsquo;t figure out why, the first step is to use a debugger to really understand the code. The (P)ython (D)e(b)ugger. Also, the (IP)ython (D)e(b)ugger. These are super handy for dropping into some code to check values/step through the code/general debugging! It combines some of the playfulness of jupyter notebooks with python modules.&lt;/p>
&lt;p>Just add these two lines:&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">import ipdb
ipdb.set_trace()
&lt;/code>&lt;/pre>&lt;/div>&lt;p>or&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">import pdb
pdb.set_trace()
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And then when those lines are run, execution will stop and I&amp;rsquo;m dropped into a debugging prompt where I can step through the code, examine variable values and other nice things.&lt;/p></description></item><item><title>Automated testing for scientists and data analysts</title><link>http://tbenthompson.com/post/automated_testing_for_science/</link><pubDate>Wed, 07 Feb 2018</pubDate><guid>http://tbenthompson.com/post/automated_testing_for_science/</guid><description>&lt;p>A lot of scientists and data analysts don&amp;rsquo;t use automatic test suites for verifying their code.
And I think that&amp;rsquo;s because it&amp;rsquo;s really hard.
Almost all the introductions to automated testing that I&amp;rsquo;ve seen come from a more typical software engineering perspective. They assume you already know exactly what the output of your code should be.
And the trouble with science is that that&amp;rsquo;s rarely the case.
I mean, if you knew the results ahead of time, you wouldn&amp;rsquo;t be doing science!&lt;/p>
&lt;p>It&amp;rsquo;s hard to square this situation with the consistent loud noises coming from the software development world (in my case, also from inside my head!) saying &amp;ldquo;It might be broken! Write tests! Write tests! Write tests!&amp;rdquo;. &amp;ldquo;But, I can&amp;rsquo;t!&amp;rdquo;&lt;/p>
&lt;p>I&amp;rsquo;ve been dealing with this battle for a few years now and feel like I&amp;rsquo;ve figured out some coping strategies.
The simplest solution is to just give up.
And for some types of science, I think that&amp;rsquo;s the right thing to do.
Essentially, whether or not to test is a question of how important it is that the results are correct.
In that sense, I don&amp;rsquo;t think automated testing makes sense for exploratory analysis.
But, for a reusable algorithm or production/final analysis, tests are invaluable.
My work flow mostly involves Python and C++. So, in my case, the question of whether something should be tested often goes hand in hand with whether I&amp;rsquo;m working in a Jupyter notebook or with a proper package.&lt;/p>
&lt;p>So, let&amp;rsquo;s back up and ask: why should we have automated tests?&lt;/p>
&lt;h2 id="automated-testing">Automated testing&lt;/h2>
&lt;p>Automated testing is valuable for ensuring that software does what is is supposed to do. Automated testing:&lt;/p>
&lt;ul>
&lt;li>reduces fear when making implementation or design changes (this is huge, in my opinion!) One perspective on when to write tests is to write tests whenever you feel afraid of making a change and to keep writing tests until your not afraid anymore.&lt;/li>
&lt;li>enables rapid refactoring without fear of breaking the code base&lt;/li>
&lt;li>gives instant feedback&lt;/li>
&lt;li>helps improve software accuracy, correctness&lt;/li>
&lt;li>provides a form of precise documentation&lt;/li>
&lt;/ul>
&lt;p>&lt;a href="https://stackoverflow.com/questions/67299/is-unit-testing-worth-the-effort">A couple good discussions of why we should unit test.&lt;/a>&lt;/p>
&lt;p>I&amp;rsquo;ve also enjoyed the book &amp;ldquo;Working Effectively with Legacy Code&amp;rdquo; by Michael Feathers, because it focuses on adding tests to previously untested and maybe poorly designed &amp;ldquo;legacy&amp;rdquo; code (which he defines as any code without tests!).
&lt;a href="https://softwareengineering.stackexchange.com/questions/122014/what-are-the-key-points-of-working-effectively-with-legacy-code">A summary of the book.&lt;/a>&lt;/p>
&lt;p>But, returning to the original problem, automated testing can be very difficult in science and analytics because the true answer is not known. Sometimes low level functions can be assigned a &amp;ldquo;correct&amp;rdquo; result. But, for higher level constructs (e.g. an entire time series forecast or the solution of a complex PDE), it&amp;rsquo;s normally much harder to determine what is right and wrong. It requires careful input from the statistician/scientist/analyst to determine if something looks right or wrong and whether there&amp;rsquo;s anything fishy going on.&lt;/p>
&lt;p>So, given that we want to have automated tests, but the inherent nature of the problem makes most testing difficult, what do we do? I still struggle with this issue and am learning all the time, but I&amp;rsquo;ve found three types of approaches particularly useful:&lt;/p>
&lt;h2 id="special-cases">Special cases&lt;/h2>
&lt;p>This first approach is the most common, the simplest, and often the most valuable.
Suppose I&amp;rsquo;m writing a &lt;a href="https://github.com/tbenthompson/tectosaur">general algorithm for numerically solving elastic partial differential equations for an arbitrary geometry and set of boundary conditions&lt;/a>.
It might be really hard to say whether the answer I&amp;rsquo;m getting is correct for
any given problem. But some specific problems have already been solved analytically.
For example, a spherically symmetric problem is easily solved by hand and any number of textbooks
have exact solutions. Or, similarly, the motion of the Earth due to an planar earthquake in an infinite flat Earth has &lt;a href="http://www.bosai.go.jp/study/application/dc3d/DC3Dhtml_E.html">a well known solution&lt;/a>.&lt;/p>
&lt;p>In some cases, there are very general approaches for building special cases. For example, anyone writing numerical methods for solving PDEs should absolutely learn about the &lt;a href="http://www.personal.psu.edu/jhm/ME540/lectures/VandV/MMS_summary.pdf">method of manufactured solutions&lt;/a>, which lets you come up with as many arbitrary test problems as you need.&lt;/p>
&lt;p>Unfortunately, even if there are useful special cases, often the resulting tests only validate the program as a whole. What if that program involves thousands of lines of code? I&amp;rsquo;d prefer to be able to test smaller portions of the code base on their own.&lt;/p>
&lt;h2 id="property-testing">Property testing&lt;/h2>
&lt;p>I think property testing is the most useful approach when the answer isn&amp;rsquo;t known. Instead of check the final answer, we check a &lt;em>property&lt;/em> of some final or intermediate part of the calculation. For example:&lt;/p>
&lt;ul>
&lt;li>Newton&amp;rsquo;s method for root finding should take exactly one step to solve any linear system of equations. So, a simple property test might be to generate 100 random linear systems and check that all of them are solved in one step. The difference from a special case is that we have a simple algorithm for generating many special cases.&lt;/li>
&lt;li>In the case of a finite element or boundary element model, the solution should converge with increasing mesh density.&lt;/li>
&lt;li>Running an idempotent function 100 times should leave the system in the same state as running it once.&lt;/li>
&lt;li>With an infinite penalty, ridge and lasso regressions return all zeros. With a penalty of zero, ridge and lasso regressions return the same answer as unregularized least squares.&lt;/li>
&lt;/ul>
&lt;p>I&amp;rsquo;ve always written property tests by hand, but there are some libraries that attempt to automate part of the process. They&amp;rsquo;re probably more useful if you are writing code that might receive inputs from the &amp;ldquo;outside&amp;rdquo; and thus must check behavior in funky edge cases (zero length lists, NaNs, Infinity, etc).
Many property testing libraries are descended from the original QuickCheck Haskell library.
I&amp;rsquo;ve heard good things about &lt;a href="https://github.com/HypothesisWorks/hypothesis-python">Hypothesis&lt;/a>.&lt;/p>
&lt;h2 id="golden-master-testing">Golden master testing&lt;/h2>
&lt;p>Property testing is great, because it links the test back to some fundamental
property of the code/math. The trouble is that it still requires knowing &lt;em>something&lt;/em>
about what the code should do. What if you really have no clue what the output
should be, or encoding the properties is too difficult to do in a repeat-able
automated test and requires human input? But you still want to make sure that your refactoring and future development don&amp;rsquo;t break the current implementation.&lt;/p>
&lt;p>That&amp;rsquo;s where golden master testing shines. Also known as characterization testing. The idea here is very simple. Choose some input (if that includes randomness, set the random seed manually!). Then, run your function and save the output to a file. Later, to test that the behavior of the function has not changed, run it again on the same input and check that the output matches the previous output exactly.&lt;/p>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Characterization_test">Wikipedia&lt;/a> has a good discussion of the advantages and disadvantages of this type of testing. The main two points:&lt;/p>
&lt;ul>
&lt;li>it enables testing even if you have no idea what the correct result is. Common in science and analytics. Also, common in legacy systems&amp;hellip;&lt;/li>
&lt;li>it only prevents unwanted side effects of software changes, it doesn&amp;rsquo;t actually check that the answer is correct.&lt;/li>
&lt;/ul>
&lt;h2 id="testing-through-monte-carlo-simulation-a-special-kind-of-property-test-guest-section-by-liz-santorella">Testing through Monte Carlo simulation: A special kind of property test (guest section by Liz Santorella)&lt;/h2>
&lt;p>Many statistical algorithms are designed with the following setup in mind:
Assume that data is drawn from some known distribution $D$ with unknown parameters $\theta$.
We don&amp;rsquo;t know $\theta$, but the algorithm $A$ returns $\hat{\theta} \approx \theta$,
with the estimate becoming precise as the data grows large.&lt;/p>
&lt;!---
For example,
say we have a series of observations $y_1, y_2, \dots, y_N$ and we assume they are drawn independently from
the Normal$(\mu, \sigma)$ distribution. We don't know $\mu$ or $\sigma$. Applying the algorithm $A$ to the
data should give the unknown parameters, approximately: $A(y_1, y_2, \dots, y_N) \approx (\mu, \sigma)$.
-->
&lt;p>In such a setup, we can make up some parameters, create fake data drawn according
to a distribution with those parameters, and check that, when data is large, the algorithm
returns parameter estimates very close to the parameters you put in.&lt;/p>
&lt;p>The appeal of this method is that it allows you to know what the right answer for your
entire procedure is (you made up the data, after all). The downside is that your algorithm
may only work accurately when your data is very large, so the test can take a long time to
run. It can also be hard to tell what counts as a correct answer: If you put in the parameter
$\mu=1$ and recover $\hat{\mu}=1.002$, is the discrepancy becuase your Monte Carlo data is too
small or because your code is wrong?&lt;/p>
&lt;p>In practice, I often combine Monte Carlo simulation testing with Golden Master testing.
I run Monte Carlo simulations for several parameter values, including some interesting
edge cases. Then once I&amp;rsquo;m satisfied that the code works, I run it on a very small example,
save both the inputs and the outputs, and make those inputs and outputs into a Golden Master test.
I don&amp;rsquo;t automate the Monte Carlo test itself &amp;ndash; it takes too long to run, and its guarantees
are only probabilistic.&lt;/p>
&lt;!---
## Making sure it runs
Sometimes, you don't have time to figure out how to check that your code produces the correct output,
but you can still check that it runs without raising errors. Although this can easily be done in a unit testing
framework, I like to make sure my code runs by creating a Jupyter notebook
that calls almost every line of code that I think is important. I explain why the code behaves
the way it does in the notebook, which then makes pretty good documentation.
--></description></item><item><title>Sneaky (transparent) huge pages</title><link>http://tbenthompson.com/post/sneaky-transparent-huge-pages/</link><pubDate>Wed, 17 Jan 2018</pubDate><guid>http://tbenthompson.com/post/sneaky-transparent-huge-pages/</guid><description>&lt;p>A week ago, I spent an afternoon on a run in with a sneaky feature of the Linux kernel that made some sparse matrix vector product operations about twice as slow as I expected.&lt;/p>
&lt;p>I&amp;rsquo;ve recently learned about using file backed shared memory with mmap to do efficient interprocess communication. At the most basic level, you share data between two processes by writing that data to a file. The file can be made to look a lot like a normal region of memory using &lt;code>mmap&lt;/code>, a system call, and can be shared between multiple processes by giving &lt;code>mmap&lt;/code> the &lt;code>MAP_SHARED&lt;/code> flag. There&amp;rsquo;s a downside though, in that the data has to synced to the hard drive continuously. So, instead of sharing a file that is written to disk, I discovered that you can share a file on a RAM disk &amp;ndash; just a filesystem that is backed by RAM. On Linux, a large &lt;code>tmpfs&lt;/code> RAM disk filesystem is often mounted by default at &lt;code>/dev/shm&lt;/code>.&lt;/p>
&lt;p>Here&amp;rsquo;s some python that creates a NumPy array with &lt;code>mmap&lt;/code>. First, let&amp;rsquo;s get set up&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;span class="kn">import&lt;/span> &lt;span class="nn">mmap&lt;/span>
&lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">5e7&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">nb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">n&lt;/span>
&lt;span class="n">filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/dev/shm/abc&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, we need to make sure that the file is the correct size using &lt;code>ftruncate&lt;/code>. Finally, we memory map it into a numpy array. &lt;code>np.frombuffer&lt;/code> is a handy function when you already have a memory buffer and just want to &amp;ldquo;view&amp;rdquo; it as a numpy array without copying the memory.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w+b&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ftruncate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fileno&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">nb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">mem&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mmap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mmap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fileno&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">nb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">frombuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dtype&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">float64&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And for kicks, we&amp;rsquo;ll stick some random numbers in there&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">x&lt;/span>&lt;span class="p">[:]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">rand&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">x&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>array([ 0.84984349, 0.5928336 , 0.34455741, ..., 0.45909949, 0.51389915, 0.36287542])
&lt;/code>&lt;/pre>
&lt;p>Looks like everything is working! Right? Okay, so now I&amp;rsquo;m going to create another array of the same size with random indexes into the first array.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">idx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">random&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">randint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And then, benchmark an indexing operation on &lt;code>x&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="o">%&lt;/span>&lt;span class="n">timeit&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>1.39 s ± 92.1 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
&lt;/code>&lt;/pre>
&lt;p>So, this is where it gets really interesting&amp;hellip; What if we copy &lt;code>x&lt;/code> and then do the benchmark again?&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">x2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">copy&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="o">%&lt;/span>&lt;span class="n">timeit&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>691 ms ± 117 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
&lt;/code>&lt;/pre>
&lt;p>When I finally tracked down this performance bug, I was astonished. Why would copying an array make an indexing operation run almost twice as fast?! At first, I did a whole lot of mind-blown I-dont-undestand-this googling including lots of hopelessly nondescript attempts like &amp;ldquo;numpy copy speed up&amp;rdquo; or &amp;ldquo;copy speeds up indexing operation&amp;rdquo;.&lt;/p>
&lt;p>Eventually, I tried to think it through. If copying an array makes an operation faster, then by implication, not all memory is made equal. Some memory is faster to access or manipulate than other memory. I was already aware of NUMA (non-uniform memory access), a feature of multi-socket servers that means that cores can access certain chunks of memory several times faster than other &amp;ldquo;further&amp;rdquo; chunks. Maybe &lt;code>mmap&lt;/code> is less likely to allocate memory close to the core that needs it, thus causing NUMA issues? But, this copy-speeds-everything-up behavior happens on my laptop, so it can&amp;rsquo;t be a NUMA issue.&lt;/p>
&lt;p>I thought the key must be in way I&amp;rsquo;ve created this particular chunk of memory. It&amp;rsquo;s is a bit out of the ordinary to be using mmap. Again, I tried searching all sorts of vague things about &amp;ldquo;mmap memory slower&amp;rdquo; or &amp;ldquo;mmap performance&amp;rdquo;, thinking that maybe something in the way mmap synchronizes to the RAM disk was causing the performance problems. Alas, no one on the internet seemed to be having these problems! At a loss, I just started fiddling around with the mmap flags to see if different options fixed the problem and I discovered a key clue.&lt;/p>
&lt;p>Using &lt;code>mmap&lt;/code> with the &lt;code>MAP_PRIVATE&lt;/code> flag boosted performance of the indexing operation to the same speed as when I copied &lt;code>x&lt;/code>.&lt;/p>
&lt;p>Around the same point, I had another thought. The current indexes are random. Random indexing of a 50 million element array is bound to cause some caching problems. Does copying speed up a sequential indexing operation? Say, we just skip every other element. Let&amp;rsquo;s try it!&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">idx_seq&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">arange&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="o">%&lt;/span>&lt;span class="n">timeit&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx_seq&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>62.8 ms ± 2.07 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="o">%&lt;/span>&lt;span class="n">timeit&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx_seq&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>62.1 ms ± 1.47 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
&lt;/code>&lt;/pre>
&lt;p>First off, sequential indexing is much faster because it has much better cache utilization (actually, pretty much ideal cache utilization). I mean it&amp;rsquo;s just a copying operation! This is going to be a memory bandwidth bound operation, so let&amp;rsquo;s calculate really quickly what type of memory bandwidth my little laptop is achieving.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">t_sec&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0621&lt;/span>
&lt;span class="n">total_bytes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nbytes&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">idx_linear&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nbytes&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nbytes&lt;/span>
&lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">total_bytes&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">t_sec&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mf">1e9&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;GB/s&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>12.882447665056361 GB/s
&lt;/code>&lt;/pre>
&lt;p>Wow! I&amp;rsquo;m pretty sure that&amp;rsquo;s close to the peak memory bandwidth possible from this laptop.&lt;/p>
&lt;p>Secondly, the linear memory access is just as fast for the &lt;code>mmap&lt;/code>-ed memory as it is for the memory obtained by &lt;code>x.copy()&lt;/code> (presumably deep inside numpy there&amp;rsquo;s a &lt;code>malloc&lt;/code> call). So, while it&amp;rsquo;s straightforward to say that a random memory access pattern is much slower than a sequential access pattern, there&amp;rsquo;s still the problem of what would make random access slower on some blocks of memory than others. Now, I had something more concrete to start googling&amp;hellip; &amp;ldquo;mmap slow random memory access&amp;rdquo;. And, finally, the first result was my &lt;a href="https://stackoverflow.com/questions/44001260/random-mmaped-memory-access-up-to-16-slower-than-heap-data-access/44152743">salvation from stack overflow&lt;/a>.&lt;/p>
&lt;p>The random memory access on the &lt;code>mmap&lt;/code>-ed memory was slower because each access had to not only load the memory all the way from RAM rather than cache, but also had to load the physical location of that virtual memory from RAM rather than cache. This is because &lt;code>mmap&lt;/code>-ed shared memory defaults to using traditional 4kB memory pages while, for most recent Linux installation, &lt;code>malloc&lt;/code> default to using 2MB huge pages. The 4kB pages result in far more TLB (translation lookaside buffer) cache misses. Our 400MB chunk of memory would requires 100,000 page table entries with 4kb pages &amp;ndash; way more than fit in the TLB cache.&lt;/p>
&lt;p>There was a whole bunch of jargon I didn&amp;rsquo;t define in that last paragraph. Maybe in a future post, I&amp;rsquo;ll go through the details of how virtual memory, the TLB, Huge Pages and Transparent Huge Pages all work. This &lt;a href="https://dzone.com/articles/memory-access-patterns-are">page&lt;/a> has some comprehensive descriptions. but just to finish this post out, I&amp;rsquo;ll show some performance counters demonstrating the TLB cache miss problem. The first example is using 4kB pages, while the second is using 2MB huge pages. There are 200x fewer TLB cache misses using huge pages.&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-fallback" data-lang="fallback">
➜ examples git:(master) ✗ perf stat -e dTLB-load-misses python mmap_bench.py shmem 1
shm square 0.4846489429473877
Performance counter stats for &amp;#39;python mmap_bench.py shmem 1&amp;#39;:
19,313,497 dTLB-load-misses
1.159249907 seconds time elapsed
➜ examples git:(master) ✗ perf stat -e dTLB-load-misses python mmap_bench.py shmemhuge 1
shm square 0.2850306034088135
Performance counter stats for &amp;#39;python mmap_bench.py shmemhuge 1&amp;#39;:
91,545 dTLB-load-misses
0.895894488 seconds time elapsed
&lt;/code>&lt;/pre>&lt;/div>&lt;p>And let&amp;rsquo;s check our original problem by using a separate &lt;code>hugetlbfs&lt;/code> RAM disk using huge pages mounted at &lt;code>/mnt/hugepages&lt;/code> (remember before we used &lt;code>/dev/shm&lt;/code>).&lt;/p>
&lt;div class="highlight">&lt;pre class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="n">filename&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/mnt/hugepages/abc&amp;#39;&lt;/span>
&lt;span class="n">page_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">2.0&lt;/span> &lt;span class="o">**&lt;/span> &lt;span class="mi">21&lt;/span>
&lt;span class="c1"># Using huge pages requires using a number bytes that is an exact multiply of the page size&lt;/span>
&lt;span class="n">nb_rounded_to_page_size&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">page_size&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ceil&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">nb&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">page_size&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">filename&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;w+b&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ftruncate&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fileno&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">nb_rounded_to_page_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">mem&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">mmap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mmap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fileno&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">nb_rounded_to_page_size&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">frombuffer&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">mem&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dtype&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">float64&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="o">%&lt;/span>&lt;span class="n">timeit&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">idx&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>657 ms ± 39.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
&lt;/code>&lt;/pre>
&lt;p>Hurray! Success!&lt;/p></description></item><item><title>Sparse n-body matrices</title><link>http://tbenthompson.com/post/sparse_nbody/</link><pubDate>Sat, 02 Jul 2016</pubDate><guid>http://tbenthompson.com/post/sparse_nbody/</guid><description>&lt;p>&lt;img src="http://tbenthompson.com/images/sparse_treecode_matrix.png" alt="matrix">&lt;/p>
&lt;p>This is a sparsity plot of a matrix representing an approximate n-body interaction. The black dots are non-zeros in the matrix. Imagine 2000 stars, each exerting some gravitational pull on each of the other stars. This gravitational interaction could be represented by a dense matrix:&lt;/p>
&lt;p>$$
A_{ij} = \frac{G m_i m_j}{|\mathbf{x}_i - \mathbf{x}_j|^2}
$$&lt;/p>
&lt;p>This works, but dense matrices can be slow when there are many stars. The cost of evaluating a matrix-vector product will scale like $O(n^2)$. Fortunately, the matrix can be represented in a different way if a little bit of error is okay. The interactions can be separated into those between nearby stars and the remaining interactions between stars that are far from each other. Groups of farfield interactions can be approximated. The result is a matrix that looks like what I&amp;rsquo;m showing above. The matrix has four distinct blocks. The upper left 2000x2000 block of the matrix represents the direct interaction that could not be approximated. The lower left and lower right represent the evaluation of the approximation coefficients. Both are super sparse! The upper right is the evaluation of the influence of the approximation coefficients on the points themselves. This part is less sparse.&lt;/p>
&lt;p>Depending on exactly where the matrix coefficients are coming and how the approximation is done, this idea is called a tree-code, the fast multipole method, or a hierarchical matrix and results in an asymptotic complexity of either $O(n)$ or $O(n\log{n})$. The matrix in the figure is too small to show the impressive sparsification achievable with these methods. With a larger problem including 500,000 interacting points, I need &amp;lt;0.1% of the original number of matrix entries (250 billion vs 0.2 billion).&lt;/p>
&lt;p>I&amp;rsquo;m using this same idea for elastic interactions in the Earth&amp;rsquo;s crust. The interaction kernel is different, but the idea is fundamentally the same. I&amp;rsquo;m using a specific variant of the fast multipole method called the &lt;a href="http://www.mrl.nyu.edu/~harper/kifmm3d/documentation/publications.html">kernel independent fast multipole method&lt;/a>. This is a nice approach since the implementation is the same for each of the interaction kernels I deal with.&lt;/p></description></item><item><title>"Serializing" a function in C++</title><link>http://tbenthompson.com/post/serialize_fnc_cpp/</link><pubDate>Wed, 23 Dec 2015</pubDate><guid>http://tbenthompson.com/post/serialize_fnc_cpp/</guid><description>&lt;script src="https://gist.github.com/tbenthompson/94fd4095f89da23dec20.js">&lt;/script></description></item><item><title>Setting up my website</title><link>http://tbenthompson.com/post/setting_up_website/</link><pubDate>Fri, 11 Dec 2015</pubDate><guid>http://tbenthompson.com/post/setting_up_website/</guid><description>&lt;p>I have a website now. Since technical stuff is fun, I thought I&amp;rsquo;d share the way I set it up.&lt;/p>
&lt;p>The site is a set of statically served HTML pages. &lt;a href="https://gohugo.io/">Hugo&lt;/a> makes this really easy. Hugo is super fast and is written in Go. You can set up a few template pages and then write posts and pages in Markdown. Some layout is also done using Go templates. Running Hugo takes your templates and pages and concerts them into static HTML. The pages can then be dropped into any web accessible folder and accessed remotely. This is nice, but a few additional steps makes everything even easier:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://pages.github.com/">GitHub Pages&lt;/a> serves the pages from a git repository.&lt;/li>
&lt;li>The &lt;a href="https://themes.gohugo.io/kiss/">Kiss template&lt;/a> provided a nice starting theme. I modified it a bit aiming for a very simple layout and style.&lt;/li>
&lt;li>This &lt;a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/">Hugo documentation on using it with GitHub&lt;/a> has some good suggestions including a very helpful &lt;code>deploy.sh&lt;/code> script that makes deploying changes super easy.&lt;/li>
&lt;/ul>
&lt;p>You can take a look at all this &lt;a href="https://github.com/tbenthompson/tbenthompson_site">here&lt;/a>&lt;/p></description></item><item><title/><link>http://tbenthompson.com/thanks/</link><pubDate>Mon, 01 Jan 0001</pubDate><guid>http://tbenthompson.com/thanks/</guid><description>&lt;p>Thanks so much for subscribing! You should get an email confirming your subscription.&lt;/p>
&lt;p>It&amp;rsquo;d be awesome if you want to tell me a bit about yourself, what you&amp;rsquo;d like to read more of, and what you&amp;rsquo;ve been interested in lately? You can reply to the subscription confirmation email!&lt;/p></description></item></channel></rss>