<!doctype html><html lang=en-us><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>My Python testing set up | T. Ben Thompson</title>
<meta name=title content="My Python testing set up"><meta name=description content="To follow up on the last post about testing for science and data analytics, I thought it&rsquo;d be nice to talk about the specific tools I use for testing. I don&rsquo;t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.
py.test The py.test tool is handy for running a suite of tests in python. It&rsquo;s a very general tool for running all the tests in a project."><meta name=keywords content><meta property="og:url" content="https://tbenthompson.com/post/how_i_test/"><meta property="og:site_name" content="T. Ben Thompson"><meta property="og:title" content="My Python testing set up"><meta property="og:description" content="To follow up on the last post about testing for science and data analytics, I thought it’d be nice to talk about the specific tools I use for testing. I don’t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.
py.test The py.test tool is handy for running a suite of tests in python. It’s a very general tool for running all the tests in a project."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-02-22T00:00:00+00:00"><meta property="article:modified_time" content="2018-02-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="My Python testing set up"><meta name=twitter:description content="To follow up on the last post about testing for science and data analytics, I thought it’d be nice to talk about the specific tools I use for testing. I don’t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.
py.test The py.test tool is handy for running a suite of tests in python. It’s a very general tool for running all the tests in a project."><meta itemprop=name content="My Python testing set up"><meta itemprop=description content="To follow up on the last post about testing for science and data analytics, I thought it’d be nice to talk about the specific tools I use for testing. I don’t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.
py.test The py.test tool is handy for running a suite of tests in python. It’s a very general tool for running all the tests in a project."><meta itemprop=datePublished content="2018-02-22T00:00:00+00:00"><meta itemprop=dateModified content="2018-02-22T00:00:00+00:00"><meta itemprop=wordCount content="700"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{display:block;padding:5px;white-space:pre-wrap;font-size:13px}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}</style><script src=/js/mathjax_setup.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZWYJW88C4N"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZWYJW88C4N")</script><link rel=stylesheet href=/css/custom.css><link rel=stylesheet href=/css/syntax.css></head><body><header><nav><a href=/>Home</a>
<a href=/whatido>Work with me</a>
<a href=/post>Posts</a>
<a href=/project>Past Projects</a>
<a href=/book>BIE Tutorials</a></nav></header><main><h2>My Python testing set up</h2><p><i><time datetime=2018-02-22 pubdate>22 Feb, 2018</time></i></p><content><p>To follow up on the last post about testing for science and data analytics, I thought it&rsquo;d be nice to talk about the specific tools I use for testing. I don&rsquo;t claim this is the best way to do things, but it tends to work pretty well for small projects and teams.</p><h2 id=pytest>py.test</h2><p>The py.test tool is handy for running a suite of tests in python. It&rsquo;s a very general tool for running all the tests in a project. It can do a lot of powerful things, but requires almost no boilerplate to get started with. The pattern I&rsquo;ve always followed is: Add a <code>tests</code> directory the root of the project. Name any test files in that directory <code>test_xyz.py</code> and then any tests within that file <code>def test_abc():</code>. py.test will find all of these automatically and run them. On several projects that I work on, I have tens or hundreds of tests that, in total, take less than a second to run. As a result, I simply run <code>py.test</code> every time I make a change.</p><p>For more happiness, I add a <code>pytest.ini</code> file to the root of my project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[pytest]
</span></span><span class=line><span class=cl>addopts = -s --tb=short
</span></span></code></pre></div><p>The <code>-s</code> causes any text printed by my tests or code to appear on the screen. By default, py.test suppresses printing/logging to standard out. Personally, I don&rsquo;t like that while debugging.
The <code>--tb=short</code> leads to shorter, more concise tracebacks in the case of test failures.</p><p>There are a ton of other features available with py.test, like fixtures, fancy assertions and lots of plugins. Here&rsquo;s <a href=http://pythontesting.net/framework/pytest/pytest-introduction/>a more comprehensive intro to py.test</a></p><h2 id=golden-master-tests>Golden master tests</h2><p>Golden master testing doesn&rsquo;t really <strong>require</strong> any special infrastructure, but it can be nice to have a coordinated way to generate the keys and specify golden master tests. First, I set up a configuration option in <code>tests/conftest.py</code>. This is a special file that <code>py.test</code> uses to load plugins and configuration.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def pytest_addoption(parser):
</span></span><span class=line><span class=cl>    parser.addoption(
</span></span><span class=line><span class=cl>        &#34;--save-golden-masters&#34;, action=&#34;store_true&#34;,
</span></span><span class=line><span class=cl>        help=&#34;reset golden master benchmarks&#34;
</span></span><span class=line><span class=cl>    )
</span></span></code></pre></div><p>Then, what you do with this depends on the project. In one project, where I&rsquo;m normally compare numpy arrays, I have a decorator that makes setting up a golden master test really simple.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>def</span> <span class=nf>golden_master</span><span class=p>(</span><span class=n>digits</span> <span class=o>=</span> <span class=mi>6</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>test_fnc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>save</span> <span class=o>=</span> <span class=n>pytest</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>getoption</span><span class=p>(</span><span class=s2>&#34;--save-golden-masters&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>AttributeError</span> <span class=n>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>save</span> <span class=o>=</span> <span class=n>False</span>
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>wraps</span><span class=p>(</span><span class=n>test_fnc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>test_fnc</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>test_name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>node</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;tests&#39;</span><span class=p>,</span> <span class=s1>&#39;golden_masters&#39;</span><span class=p>,</span> <span class=n>test_name</span> <span class=o>+</span> <span class=s1>&#39;.npy&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>save</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>np</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>correct</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>np</span><span class=o>.</span><span class=n>testing</span><span class=o>.</span><span class=n>assert_almost_equal</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>correct</span><span class=p>,</span> <span class=n>digits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorator</span>
</span></span></code></pre></div><p>To use this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@golden_master(4)
</span></span><span class=line><span class=cl>def test_mycomplexfnc(request):
</span></span><span class=line><span class=cl>    return mycomplexfnc()
</span></span></code></pre></div><p>When I run <code>py.test --save-golden-masters</code>, this will automatically save the result of the function to <code>tests/golden_masters/test_mycomplexfnc.npy</code>. Then, the next time I run <code>py.test</code>, the output of the <code>mycomplexfnc()</code> will be compared to 4 digits against the old saved version.</p><p>Modifying this to work with pandas dataframes or other objects would be relatively simple. It could also be refactored to work with general objects without much effort, but, in my case, all the functions where I don&rsquo;t have anything better than a golden master test are functions that return arrays.</p><p>Should you put the saved golden master test results in version control? I would say yes, since they are necessary for properly testing the code base.</p><h2 id=slow-tests>Slow tests</h2><p>Sometimes I have tests that take a little while to run and I don&rsquo;t want them to run every single time I run <code>py.test</code>. So, I add an opt-in option for running slow tests, following the directions <a href=https://docs.pytest.org/en/latest/example/simple.html#control-skipping-of-tests-according-to-command-line-option>on the py.test docs</a>.</p><h2 id=pdb--ipdb>pdb + ipdb</h2><p>I thought I&rsquo;d just add a note about debuggers, since I&rsquo;m way more productive with a debugger at hand. When my tests fail and I can&rsquo;t figure out why, the first step is to use a debugger to really understand the code. The (P)ython (D)e(b)ugger. Also, the (IP)ython (D)e(b)ugger. These are super handy for dropping into some code to check values/step through the code/general debugging! It combines some of the playfulness of jupyter notebooks with python modules.</p><p>Just add these two lines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import ipdb
</span></span><span class=line><span class=cl>ipdb.set_trace()
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import pdb
</span></span><span class=line><span class=cl>pdb.set_trace()
</span></span></code></pre></div><p>And then when those lines are run, execution will stop and I&rsquo;m dropped into a debugging prompt where I can step through the code, examine variable values and other nice things.</p></content><link href=//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css rel=stylesheet type=text/css><div id=mc_embed_signup style="padding:20px 0"><form action="https://tbenthompson.us1.list-manage.com/subscribe/post?u=be25bc8a8ab56f1fb3e6651c2&amp;id=b407942450" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><label for=mce-EMAIL style=font-weight:400>If you enjoyed this post, please subscribe!</label>
<input type=email name=EMAIL class=email id=mce-EMAIL placeholder=email@address.com required><div style=display:none><input type=checkbox value=1 name=group[377262][1] id=mce-group[377262]-377262-0 checked>Posts
<input type=checkbox value=2 name=group[377262][2] id=mce-group[377262]-377262-1>BIEBook</div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_be25bc8a8ab56f1fb3e6651c2_b407942450 tabindex=-1></div><div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div></div></form></div><p></p></main><footer><div class=container><div class=accounts><a href=/resume.pdf>Resume</a> &nbsp/&nbsp <a href="https://scholar.google.com/citations?user=ED9oDz8AAAAJ&hl=en">Google Scholar</a> &nbsp/&nbsp <a href=https://github.com/tbenthompson>GitHub</a> &nbsp/&nbsp <a href=https://www.linkedin.com/in/ben-thompson-645292125/>LinkedIn</a> &nbsp/&nbsp <a href=https://twitter.com/tbenthompson>Twitter</a> &nbsp/&nbsp <a href=mailto:t.ben.thompson@gmail.com>Email</a></div></div></footer></body></html>