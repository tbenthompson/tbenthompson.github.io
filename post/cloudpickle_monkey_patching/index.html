<!doctype html><html lang=en-us>
<head>
<meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Cloudpickle, serializing functions and monkey patching | T. Ben Thompson</title>
<meta name=title content="Cloudpickle, serializing functions and monkey patching">
<meta name=description content="I&rsquo;ve been using cloudpickle in the internals of taskloaf for a while since it allows serializing almost all functions and objects. That&rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.
Yesterday, I was curious about the internals of cloudpickle and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea.">
<meta name=keywords content>
<meta property="og:title" content="Cloudpickle, serializing functions and monkey patching">
<meta property="og:description" content="I&rsquo;ve been using cloudpickle in the internals of taskloaf for a while since it allows serializing almost all functions and objects. That&rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.
Yesterday, I was curious about the internals of cloudpickle and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tbenthompson.com/post/cloudpickle_monkey_patching/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2018-02-24T00:00:00+00:00">
<meta property="article:modified_time" content="2018-02-24T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Cloudpickle, serializing functions and monkey patching">
<meta name=twitter:description content="I&rsquo;ve been using cloudpickle in the internals of taskloaf for a while since it allows serializing almost all functions and objects. That&rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.
Yesterday, I was curious about the internals of cloudpickle and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea.">
<meta itemprop=name content="Cloudpickle, serializing functions and monkey patching">
<meta itemprop=description content="I&rsquo;ve been using cloudpickle in the internals of taskloaf for a while since it allows serializing almost all functions and objects. That&rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.
Yesterday, I was curious about the internals of cloudpickle and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea."><meta itemprop=datePublished content="2018-02-24T00:00:00+00:00">
<meta itemprop=dateModified content="2018-02-24T00:00:00+00:00">
<meta itemprop=wordCount content="323">
<meta itemprop=keywords content>
<meta name=referrer content="no-referrer-when-downgrade">
<style>body{font-family:sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{display:block;padding:5px;white-space:pre-wrap;font-size:13px}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}code.has-jax{-webkit-font-smoothing:antialiased;background:inherit!important;border:none!important;font-size:100%}</style>
<script src=/js/mathjax_setup.js></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>MathJax={}</script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-114592151-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-114592151-1')</script>
<link rel=stylesheet href=/css/syntax.css>
</head>
<body>
<header><nav><a href=/>Home</a>
<a href=/whatido>Work with me</a>
<a href=/post>Posts</a>
<a href=/project>Past Projects</a>
<a href=/book>BIE Tutorials</a>
</nav>
</header>
<main>
<h2>Cloudpickle, serializing functions and monkey patching</h2>
<p>
<i>
<time datetime=2018-02-24 pubdate>
24 Feb, 2018
</time>
</i>
</p>
<content>
<p>I&rsquo;ve been using <code>cloudpickle</code> in the internals of <a href=https://github.com/tbenthompson/taskloaf>taskloaf</a> for a while since it allows serializing almost all functions and objects. That&rsquo;s really nice since it means I can pass arbitrary functions (tasks, jobs) from one worker to another across the network.</p>
<p>Yesterday, I was curious about the internals of <code>cloudpickle</code> and whether a monkey-patched object would remain patched after being loaded remotely. I read a bit of the source, but figured just trying it was a good idea.</p>
<p>I create a silly, meaningless class and then an instance of that class.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=c1># Create a silly class and an object</span>
<span class=k>class</span> <span class=nc>Turkey</span><span class=p>:</span>
    <span class=k>def</span> <span class=nf>hi</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>return</span> <span class=s2>&#34;hello&#34;</span>
<span class=n>t</span> <span class=o>=</span> <span class=n>Turkey</span><span class=p>()</span>
<span class=nb>print</span><span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>hi</span><span class=p>())</span>
</code></pre></div><pre><code>hello
</code></pre>
<p>Then, I monkey patch the <code>hi</code> method to return 1 instead of 2. <code>types.MethodType</code> turns a free-standing function into a method that automatically receives the <code>self</code> parameter.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>types</span>
<span class=k>def</span> <span class=nf>hi2</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
    <span class=k>return</span> <span class=s2>&#34;SQUAWK&#34;</span>
<span class=n>t</span><span class=o>.</span><span class=n>hi</span> <span class=o>=</span> <span class=n>types</span><span class=o>.</span><span class=n>MethodType</span><span class=p>(</span><span class=n>hi2</span><span class=p>,</span> <span class=n>t</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>t</span><span class=o>.</span><span class=n>hi</span><span class=p>())</span>
</code></pre></div><pre><code>SQUAWK
</code></pre>
<p>First, I&rsquo;ll try <code>pickle</code>. I dump the turkey to a binary blob and reload it.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>pickle</span>
<span class=n>blob</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
<span class=n>t2</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>blob</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>t2</span><span class=p>)</span>
</code></pre></div><pre><code>---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

&lt;ipython-input-3-21cb01513bb4&gt; in &lt;module&gt;()
      1 import pickle
      2 blob = pickle.dumps(t)
----&gt; 3 t2 = pickle.loads(blob)
      4 print(t2)


AttributeError: 'Turkey' object has no attribute 'hi2'
</code></pre>
<p><code>pickle</code> serialize a reference to the the type of the object and then expects that type to provide all the member functions needed. So, it&rsquo;s not able to handle this monkey patching situation.</p>
<p>Next, I&rsquo;ll try <code>cloudpickle</code>!</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>cloudpickle</span>
<span class=n>t2</span> <span class=o>=</span> <span class=n>cloudpickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cloudpickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>t</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>t</span> <span class=ow>is</span> <span class=n>t2</span><span class=p>)</span>
</code></pre></div><pre><code>False
</code></pre>
<p>Does the <code>hi</code> method remain changed? YES! Thank you, cloudpickle.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nb>print</span><span class=p>(</span><span class=n>t2</span><span class=o>.</span><span class=n>hi</span><span class=p>())</span>
</code></pre></div><pre><code>SQUAWK
</code></pre>
<p>Ultimately, this makes a lot of sense. <code>cloudpickle</code> just investigates the members of an object (its <code>__dict__</code>) and serializes those. It doesn&rsquo;t need to serialize anything about the generic <code>Turkey</code> class. The key difference with <code>pickle</code> is that <code>cloudpickle</code> has the capability to serialize functions and so it can directly serialize members of the object without reference to its type.</p>
</content>
<link href=//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css rel=stylesheet type=text/css>
<div id=mc_embed_signup style="padding:20px 0">
<form action="https://tbenthompson.us1.list-manage.com/subscribe/post?u=be25bc8a8ab56f1fb3e6651c2&id=b407942450" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate>
<div id=mc_embed_signup_scroll>
<label for=mce-EMAIL style=font-weight:400>If you enjoyed this post, please subscribe!</label>
<input type=email name=EMAIL class=email id=mce-EMAIL placeholder=email@address.com required>
<div style=display:none>
<input type=checkbox value=1 name=group[377262][1] id=mce-group[377262]-377262-0 checked>Posts
<input type=checkbox value=2 name=group[377262][2] id=mce-group[377262]-377262-1>BIEBook
</div>
<div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_be25bc8a8ab56f1fb3e6651c2_b407942450 tabindex=-1></div>
<div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button></div>
</div>
</form>
</div>
<p>
</p>
</main>
<footer><hr>
<div class="container has-text-centered">
<div class=accounts>
<a href=/resume.pdf>Resume</a> • <a href="https://scholar.google.com/citations?user=ED9oDz8AAAAJ&hl=en">Google Scholar</a> • <a href=https://github.com/tbenthompson>GitHub</a> • <a href=https://www.linkedin.com/in/ben-thompson-645292125/>LinkedIn</a> • <a href=https://twitter.com/tbenthompson>Twitter</a> • <a href=mailto:t.ben.thompson@gmail.com>Email</a>
</div>
<div class=accounts>
<a href=http://esantorella.com/>My wife is really smart!</a>
</div>
<div class=accounts>
<a href=https://www.instagram.com/wish.and.bean>My dogs have more social media presence than
I do.</a>
</div>
</div>
</footer>
</body>
</html>